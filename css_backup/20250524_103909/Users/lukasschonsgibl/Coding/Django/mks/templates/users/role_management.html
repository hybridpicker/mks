{% extends "templates/base.html" %}
{% load static %}

{% block tab_id %}id="role_management_tab"{% endblock %}

{% block extra_head %}
<meta name="robots" content="noindex">
<style>
.management-container { padding: 2rem 0; background: #fdfdfd; min-height: 80vh; }
.management-hero { background: #f8f9fa; border-bottom: 3px solid #D11317; padding: 2rem; text-align: center; }
.management-title { font-family: "jaf-bernina-sans-condensed", sans-serif; font-size: 2.4rem; font-weight: 800; color: #D11317; margin-bottom: 0.5rem; }
.management-subtitle { font-family: "jaf-bernina-sans-condensed", sans-serif; font-size: 1rem; color: #666; font-weight: 500; }
.stats-bar { background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 1.5rem; margin: 2rem; display: flex; justify-content: space-around; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
.stat-item { flex: 1; }
.stat-number { font-size: 1.8rem; font-weight: 700; color: #D11317; font-family: "jaf-bernina-sans-condensed", sans-serif; display: block; }
.stat-label { font-size: 0.9rem; color: #666; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
.action-bar { display: flex; justify-content: space-between; align-items: center; margin: 0 2rem 1rem; }
.btn-group { display: flex; gap: 0.5rem; }
.btn { padding: 0.8rem 1.2rem; border: none; border-radius: 6px; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; }
.btn-primary { background: #D11317; color: white; }
.btn-primary:hover { background: #b10e13; color: white; text-decoration: none; }
.btn-secondary { background: #6c757d; color: white; }
.btn-secondary:hover { background: #545b62; color: white; text-decoration: none; }
.btn-success { background: #28a745; color: white; }
.btn-success:hover { background: #218838; color: white; text-decoration: none; }
.roles-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; margin: 0 2rem; }
.role-card { background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.3s ease; }
.role-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1); transform: translateY(-2px); }
.role-header { display: flex; justify-content: between; align-items: flex-start; margin-bottom: 1rem; }
.role-info { flex: 1; }
.role-name { font-size: 1.2rem; font-weight: 700; color: #333; margin: 0 0 0.25rem 0; }
.role-description { font-size: 0.9rem; color: #666; margin: 0 0 0.5rem 0; }
.role-users { font-size: 0.8rem; color: #888; margin: 0; }
.role-status { margin-left: 1rem; }
.status-badge { padding: 0.25rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500; }
.status-active { background: #d4edda; color: #155724; }
.status-inactive { background: #f8d7da; color: #721c24; }
.permissions-summary { margin: 1rem 0; }
.permissions-title { font-size: 0.9rem; font-weight: 600; color: #555; margin-bottom: 0.5rem; }
.permissions-list { display: flex; flex-wrap: wrap; gap: 0.25rem; }
.permission-tag { background: #e9ecef; color: #495057; padding: 0.2rem 0.5rem; border-radius: 6px; font-size: 0.75rem; }
.role-actions { display: flex; gap: 0.5rem; margin-top: 1rem; }
.btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
.btn-edit { background: #ffc107; color: #212529; }
.btn-edit:hover { background: #ffb300; color: #212529; text-decoration: none; }
.btn-view { background: #17a2b8; color: white; }
.btn-view:hover { background: #138496; color: white; text-decoration: none; }
.btn-toggle { background: #6c757d; color: white; }
.btn-toggle:hover { background: #545b62; color: white; text-decoration: none; }
.btn-danger { background: #dc3545; color: white; }
.btn-danger:hover { background: #c82333; color: white; text-decoration: none; }
@media (max-width: 768px) { .management-container { padding: 1rem 0; } .stats-bar { margin: 1rem; flex-direction: column; gap: 1rem; } .action-bar { flex-direction: column; gap: 1rem; margin: 0 1rem 1rem; align-items: stretch; } .roles-grid { grid-template-columns: 1fr; margin: 0 1rem; } .role-header { flex-direction: column; align-items: flex-start; } .role-status { margin-left: 0; margin-top: 0.5rem; } .role-actions { flex-wrap: wrap; } }
</style>
{% endblock %}

{% block navbar %}{% endblock %}

{% block body %}
<div class="mbs">
  <div class="management-container">
    <div class="management-hero">
      <h1 class="management-title">Rollenverwaltung</h1>
      <p class="management-subtitle">Benutzerrollen und deren Berechtigungen verwalten</p>
    </div>

    <div class="stats-bar">
      <div class="stat-item">
        <span class="stat-number">{{ total_roles }}</span>
        <div class="stat-label">Rollen</div>
      </div>
      <div class="stat-item">
        <span class="stat-number">{{ active_roles }}</span>
        <div class="stat-label">Aktiv</div>
      </div>
    </div>

    <div class="action-bar">
      <div style="flex: 1;"></div>
      <div class="btn-group">
        <a href="{% url 'users:create_role' %}" class="btn btn-success">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="2"/>
            <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2"/>
          </svg>
          Neue Rolle
        </a>
        <a href="{% url 'users:user_management' %}" class="btn btn-primary">Benutzer verwalten</a>
        <a href="/team/" class="btn btn-secondary">Zurück</a>
      </div>
    </div>

    <div class="roles-grid">
      {% for role in roles %}
      <div class="role-card">
        <div class="role-header">
          <div class="role-info">
            <h3 class="role-name">{{ role.name }}</h3>
            <p class="role-description">{{ role.description|default:"Keine Beschreibung" }}</p>
            <p class="role-users">{{ role.users.count }} Benutzer mit dieser Rolle</p>
          </div>
          <div class="role-status">
            <span class="status-badge {% if role.is_active %}status-active{% else %}status-inactive{% endif %}">
              {% if role.is_active %}Aktiv{% else %}Inaktiv{% endif %}
            </span>
          </div>
        </div>

        <div class="permissions-summary">
          <div class="permissions-title">Berechtigungen:</div>
          <div class="permissions-list">
            {% for permission in role.get_permission_summary %}
              <span class="permission-tag">{{ permission }}</span>
            {% empty %}
              <span class="permission-tag" style="background: #f8d7da; color: #721c24;">Keine Berechtigungen</span>
            {% endfor %}
          </div>
        </div>

        <div class="role-actions">
          <a href="{% url 'users:role_permissions' role.id %}" class="btn btn-sm btn-view">Details</a>
          <a href="{% url 'users:edit_role' role.id %}" class="btn btn-sm btn-edit">Bearbeiten</a>
          <button onclick="toggleRoleStatus({{ role.id }})" class="btn btn-sm btn-toggle">
            {% if role.is_active %}Deaktivieren{% else %}Aktivieren{% endif %}
          </button>
          {% if role.users.count == 0 %}
          <a href="{% url 'users:delete_role' role.id %}" class="btn btn-sm btn-danger" onclick="return confirm('Rolle wirklich löschen?')">Löschen</a>
          {% endif %}
        </div>
      </div>
      {% empty %}
      <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #666;">
        <h4>Keine Rollen vorhanden</h4>
        <p>Erstellen Sie die erste Rolle für Ihr System.</p>
        <a href="{% url 'users:create_role' %}" class="btn btn-success">Erste Rolle erstellen</a>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
// Toggle role status
async function toggleRoleStatus(roleId) {
  try {
    const response = await fetch(, {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      location.reload();
    } else {
      const data = await response.json();
      alert(data.error || 'Fehler beim Ändern des Status');
    }
  } catch (error) {
    alert('Fehler beim Ändern des Status');
  }
}
</script>
{% endblock %}

{% block footer %}{% endblock %}