{% extends "templates/base.html" %}
{% load static %}

{% block tab_id %}id="user_management_tab"{% endblock %}

{% block extra_head %}
<meta name="robots" content="noindex">
<style>
.management-container { padding: 2rem 0; background: #fdfdfd; min-height: 80vh; }
.management-hero { background: #f8f9fa; border-bottom: 3px solid #D11317; padding: 2rem; text-align: center; }
.management-title { font-family: "jaf-bernina-sans-condensed", sans-serif; font-size: 2.4rem; font-weight: 800; color: #D11317; margin-bottom: 0.5rem; }
.management-subtitle { font-family: "jaf-bernina-sans-condensed", sans-serif; font-size: 1rem; color: #666; font-weight: 500; }
.stats-bar { background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 1.5rem; margin: 2rem; display: flex; justify-content: space-around; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
.stat-item { flex: 1; }
.stat-number { font-size: 1.8rem; font-weight: 700; color: #D11317; font-family: "jaf-bernina-sans-condensed", sans-serif; display: block; }
.stat-label { font-size: 0.9rem; color: #666; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
.action-bar { display: flex; justify-content: space-between; align-items: center; margin: 0 2rem 1rem; }
.search-box { position: relative; flex: 1; max-width: 400px; }
.search-box input { width: 100%; padding: 0.8rem 1rem 0.8rem 2.5rem; border: 1px solid #ddd; border-radius: 8px; font-size: 0.95rem; }
.search-box svg { position: absolute; left: 0.8rem; top: 50%; transform: translateY(-50%); color: #999; }
.btn-group { display: flex; gap: 0.5rem; }
.btn { padding: 0.8rem 1.2rem; border: none; border-radius: 6px; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; }
.btn-primary { background: #D11317; color: white; }
.btn-primary:hover { background: #b10e13; color: white; text-decoration: none; }
.btn-secondary { background: #6c757d; color: white; }
.btn-secondary:hover { background: #545b62; color: white; text-decoration: none; }
.btn-outline { background: transparent; border: 1px solid #D11317; color: #D11317; }
.btn-outline:hover { background: #D11317; color: white; text-decoration: none; }
.users-table { background: white; border: 1px solid #e0e0e0; border-radius: 12px; margin: 0 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden; }
.table { width: 100%; margin: 0; }
.table th { background: #f8f9fa; padding: 1rem; font-weight: 600; font-size: 0.9rem; color: #555; border-bottom: 1px solid #e0e0e0; }
.table td { padding: 1rem; border-bottom: 1px solid #f0f0f0; }
.table tr:hover { background: #f8f9fa; }
.user-avatar { width: 40px; height: 40px; border-radius: 50%; background: #D11317; display: inline-flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.9rem; margin-right: 0.8rem; }
.user-info { display: flex; align-items: center; }
.user-details h6 { margin: 0; font-size: 0.95rem; font-weight: 600; color: #333; }
.user-details p { margin: 0; font-size: 0.85rem; color: #666; }
.status-badge { padding: 0.25rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500; }
.status-active { background: #d4edda; color: #155724; }
.status-inactive { background: #f8d7da; color: #721c24; }
.role-badge { background: #e9ecef; color: #495057; padding: 0.25rem 0.6rem; border-radius: 8px; font-size: 0.8rem; font-weight: 500; }
.permissions-list { font-size: 0.8rem; color: #666; max-width: 200px; }
.action-buttons { display: flex; gap: 0.5rem; }
.btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
.btn-edit { background: #ffc107; color: #212529; }
.btn-edit:hover { background: #ffb300; color: #212529; text-decoration: none; }
.btn-toggle { background: #17a2b8; color: white; }
.btn-toggle:hover { background: #138496; color: white; text-decoration: none; }
@media (max-width: 768px) { .management-container { padding: 1rem 0; } .stats-bar { margin: 1rem; flex-direction: column; gap: 1rem; } .action-bar { flex-direction: column; gap: 1rem; margin: 0 1rem 1rem; align-items: stretch; } .users-table { margin: 0 1rem; } .table th, .table td { padding: 0.5rem; font-size: 0.8rem; } .user-info { flex-direction: column; align-items: flex-start; } .action-buttons { flex-wrap: wrap; } }
</style>
{% endblock %}

{% block navbar %}{% endblock %}

{% block body %}
<div class="mbs">
  <div class="management-container">
    <div class="management-hero">
      <h1 class="management-title">Benutzerverwaltung</h1>
      <p class="management-subtitle">Alle Benutzer und deren Rollen verwalten</p>
    </div>

    <div class="stats-bar">
      <div class="stat-item">
        <span class="stat-number">{{ total_users }}</span>
        <div class="stat-label">Benutzer</div>
      </div>
      <div class="stat-item">
        <span class="stat-number">{{ active_users }}</span>
        <div class="stat-label">Aktiv</div>
      </div>
      <div class="stat-item">
        <span class="stat-number">{{ total_roles }}</span>
        <div class="stat-label">Rollen</div>
      </div>
    </div>

    <div class="action-bar">
      <div class="search-box">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
          <path d="21 21L16.65 16.65" stroke="currentColor" stroke-width="2"/>
        </svg>
        <input type="text" id="userSearch" placeholder="Benutzer suchen...">
      </div>
      <div class="btn-group">
        <a href="{% url 'users:role_management' %}" class="btn btn-outline">Rollen verwalten</a>
        <a href="/team/" class="btn btn-secondary">Zur√ºck</a>
      </div>
    </div>

    <div class="users-table">
      <table class="table">
        <thead>
          <tr>
            <th>Benutzer</th>
            <th>Rolle</th>
            <th>Status</th>
            <th>2FA</th>
            <th>Berechtigungen</th>
            <th>Letzte Anmeldung</th>
            <th>Aktionen</th>
          </tr>
        </thead>
        <tbody id="usersTableBody">
          {% for user in users %}
          <tr data-user-id="{{ user.id }}">
            <td>
              <div class="user-info">
                <div class="user-avatar">
                  {{ user.first_name.0|default:user.username.0|upper }}{{ user.last_name.0|default:""|upper }}
                </div>
                <div class="user-details">
                  <h6>{{ user.get_full_name|default:user.username }}</h6>
                  <p>{{ user.email }}</p>
                </div>
              </div>
            </td>
            <td>
              {% if user.is_superuser %}
                <span class="role-badge" style="background: #dc3545; color: white;">Superuser</span>
              {% elif user.user_role %}
                <span class="role-badge">{{ user.user_role.name }}</span>
              {% else %}
                <span class="role-badge" style="background: #f8d7da; color: #721c24;">Keine Rolle</span>
              {% endif %}
            </td>
            <td>
              <span class="status-badge {% if user.is_active %}status-active{% else %}status-inactive{% endif %}">
                {% if user.is_active %}Aktiv{% else %}Inaktiv{% endif %}
              </span>
            </td>
            <td>
              <span class="status-badge {% if user.is_2fa_enabled %}status-active{% else %}status-inactive{% endif %}">
                {% if user.is_2fa_enabled %}
                  üîí Aktiviert
                {% else %}
                  ‚ö†Ô∏è Nicht aktiviert
                {% endif %}
              </span>
            </td>
            <td>
              <div class="permissions-list">
                {% if user.is_superuser %}
                  Alle Berechtigungen
                {% elif user.user_role %}
                  {{ user.get_permissions_list|join:", "|truncatechars:50 }}
                {% else %}
                  Keine Berechtigungen
                {% endif %}
              </div>
            </td>
            <td>
              {% if user.last_login %}
                {{ user.last_login|date:"d.m.Y H:i" }}
              {% else %}
                Nie
              {% endif %}
            </td>
            <td>
              <div class="action-buttons">
                <a href="{% url 'users:edit_user' user.id %}" class="btn btn-sm btn-edit">Bearbeiten</a>
                {% if not user.is_superuser and user != request.user %}
                <button onclick="toggleUserStatus({{ user.id }})" class="btn btn-sm btn-toggle">
                  {% if user.is_active %}Deaktivieren{% else %}Aktivieren{% endif %}
                </button>
                {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
              Keine Benutzer gefunden.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
// Search functionality
document.getElementById('userSearch').addEventListener('input', function(e) {
  const searchTerm = e.target.value.toLowerCase();
  const rows = document.querySelectorAll('#usersTableBody tr');
  
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(searchTerm) ? '' : 'none';
  });
});

// Toggle user status
async function toggleUserStatus(userId) {
  try {
    const response = await fetch(, {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      location.reload();
    } else {
      const data = await response.json();
      alert(data.error || 'Fehler beim √Ñndern des Status');
    }
  } catch (error) {
    alert('Fehler beim √Ñndern des Status');
  }
}
</script>
{% endblock %}

{% block footer %}{% endblock %}