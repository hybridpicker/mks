{% load i18n static %}
{% load static %}

<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  {% if name %}
  <title>{{ name }} - Verwaltung</title>
  {% else %}
  <title>{% block title %}Verwaltung - Musikschule St. Pölten{% endblock %}</title>
  {% endif %}
  
  <!-- Viewport Settings -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  {% block meta_tags %}
  <meta name="description" content="Verwaltungsbereich der Musikschule St. Pölten">
  <meta name="robots" content="noindex, nofollow">
  {% endblock %}
  
  {% include "templates/favicon.html" %}
  
  <!-- Base styles (minimal critical CSS) -->
  <style>
    body {
      background-color: #fdfdfd;
      color: #333;
      font-family: jaf-bernina-sans-condensed, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    
    /* Isolation container to prevent CSS conflicts */
    .mks-manage-isolated {
      /* CSS Reset für Management-Bereich */
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: jaf-bernina-sans-condensed, sans-serif;
      /* Isolate this area from external stylesheets */
      isolation: isolate;
    }
    
    .mks-manage-isolated *,
    .mks-manage-isolated *::before,
    .mks-manage-isolated *::after {
      box-sizing: border-box;
    }
    
    /* Override potential conflicts from .bs, .mbs, .bf more aggressively */
    .mks-manage-isolated * {
      /* Reset all inherited styles */
      background: inherit;
      border: 0;
      font: inherit;
      font-size: 100%;
      margin: 0;
      outline: 0;
      padding: 0;
      vertical-align: baseline;
    }
    
    .mks-manage-isolated .bs,
    .mks-manage-isolated .mbs,
    .mks-manage-isolated .bf {
      display: block !important;
      position: static !important;
      margin: 0 !important;
      padding: 0 !important;
      width: auto !important;
      height: auto !important;
      background: none !important;
      border: none !important;
      box-shadow: none !important;
      grid-area: unset !important;
      grid-template-areas: none !important;
      grid-template-columns: none !important;
      grid-auto-columns: unset !important;
      overflow: visible !important;
      text-align: left !important;
      max-height: none !important;
      margin-top: 0 !important;
      margin-left: 0 !important;
      margin-right: 0 !important;
      margin-bottom: 0 !important;
    }
    
    /* Main content area */
    .mks-manage-content {
      margin-top: 6rem; /* Account for fixed navbar */
      padding: 2rem;
      min-height: calc(100vh - 6rem);
      background-color: #fdfdfd;
      font-family: jaf-bernina-sans-condensed, sans-serif;
    }
    
    /* Loading indicator */
    .mks-manage-loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #d11317;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Error states */
    .mks-manage-error {
      background-color: #fee2e2;
      border: 1px solid #fecaca;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
      color: #dc2626;
    }
    
    .mks-manage-success {
      background-color: #ecfdf5;
      border: 1px solid #a7f3d0;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
      color: #065f46;
    }
    
    /* Responsive adjustments */
    @media (max-width: 820px) {
      .mks-manage-content {
        margin-top: 4rem;
        padding: 1rem;
        min-height: calc(100vh - 4rem);
      }
    }
  </style>
  
  {% block extra_head %}
  {% endblock %}
</head>

<body>
  <!-- Enhanced User Navigation -->
  {% if user.is_authenticated %}
    {% include "templates/user_navbar.html" %}
  {% else %}
    {% include "templates/navbar.html" %}
  {% endif %}

  <!-- Main Content Area with CSS Isolation - NO BANNERS -->
  <div class="mks-manage-isolated">
    <main class="mks-manage-content">
      {% block body %}
      {% endblock %}
    </main>
  </div>

  <!-- Management-specific Scripts -->
  <script>
    // Management utilities
    window.MksManagement = {
      // Show loading indicator
      showLoading: function(message = 'Lädt...') {
        const loader = document.createElement('div');
        loader.id = 'mks-manage-loader';
        loader.className = 'mks-manage-loading';
        loader.innerHTML = `
          <div style="text-align: center;">
            <div class="loading-spinner"></div>
            <p style="margin-top: 1rem; font-family: jaf-bernina-sans-condensed, sans-serif;">${message}</p>
          </div>
        `;
        document.body.appendChild(loader);
      },
      
      // Hide loading indicator
      hideLoading: function() {
        const loader = document.getElementById('mks-manage-loader');
        if (loader) {
          loader.remove();
        }
      },
      
      // Show notification
      showNotification: function(message, type = 'info', duration = 5000) {
        const notification = document.createElement('div');
        notification.className = `mks-manage-notification mks-manage-${type}`;
        notification.style.cssText = `
          position: fixed;
          top: 100px;
          right: 20px;
          z-index: 1003;
          background: white;
          border: 1px solid #e0e0e0;
          border-radius: 8px;
          padding: 1rem;
          box-shadow: 0 12px 40px rgba(0,0,0,0.15);
          max-width: 400px;
          animation: slideInRight 0.3s ease;
        `;
        
        if (type === 'error') {
          notification.style.borderColor = '#fecaca';
          notification.style.backgroundColor = '#fee2e2';
        } else if (type === 'success') {
          notification.style.borderColor = '#a7f3d0';
          notification.style.backgroundColor = '#ecfdf5';
        }
        
        notification.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <p style="margin: 0; font-family: jaf-bernina-sans-condensed, sans-serif; color: #333;">${message}</p>
            <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #666; margin-left: 1rem;">✕</button>
          </div>
        `;
        
        document.body.appendChild(notification);
        
        if (duration > 0) {
          setTimeout(() => {
            if (notification.parentElement) {
              notification.remove();
            }
          }, duration);
        }
      },
      
      // Confirm dialog
      confirm: function(message, callback) {
        if (window.confirm(message)) {
          callback();
        }
      },
      
      // AJAX helper with CSRF token
      ajax: function(url, options = {}) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        
        const defaultOptions = {
          headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json',
          },
          credentials: 'same-origin',
        };
        
        return fetch(url, { ...defaultOptions, ...options });
      }
    };
    
    // Auto-hide messages after 5 seconds
    document.addEventListener('DOMContentLoaded', function() {
      const messages = document.querySelectorAll('.mks-manage-error, .mks-manage-success');
      messages.forEach(message => {
        setTimeout(() => {
          message.style.opacity = '0';
          setTimeout(() => message.remove(), 300);
        }, 5000);
      });
    });
  </script>
  
  {% block footer %}
  <!-- Management pages typically don't need the main footer -->
  {% endblock %}
  
  {% block extra_scripts %}
  {% endblock %}
</body>
</html>
