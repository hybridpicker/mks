{% load static %}

<!-- Overlay Menu CSS -->
<link rel="stylesheet" href="{% static 'css/navigation/overlay_menu.css' %}">

<!-- Enhanced Admin Dashboard Navigation -->
<header id="UserNav">
  <div class="mks-navbar-manage-container">
    <!-- Logo Area -->
    <div class="mks-navbar-manage-logo">
      <a href="{% url 'home_view' %}" aria-label="Zur Startseite">
        {% include "templates/svg/nav_bar_icon.html" %}
      </a>
    </div>
    
    <!-- Navigation Area -->
    <div class="mks-navbar-manage-nav">
      <div class="mks-navbar-manage-actions">
        
        <!-- Management Mega-Dropdown -->
        <div class="mks-navbar-manage-dropdown">
          <button class="mks-navbar-manage-trigger" aria-haspopup="true" aria-expanded="false">
            <svg class="mks-navbar-manage-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
            </svg>
            <span>Verwaltung</span>
            <svg class="mks-navbar-manage-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          
          <!-- Mega Dropdown Content -->
          <div class="mks-navbar-manage-mega">
            <div class="mks-navbar-manage-grid">
              
              <!-- Content Management Column -->
              <div class="mks-navbar-manage-section">
                <h3>Inhalte verwalten</h3>
                <div class="mks-navbar-manage-items">
                  <a href="{% url 'show_blogs_editing' %}" class="mks-navbar-manage-item">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M12 20h9"></path>
                      <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                    </svg>
                    <span>Blog verwalten</span>
                  </a>
                  <a href="{% url 'get_all_faqs' %}" class="mks-navbar-manage-item">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="12" cy="12" r="10"></circle>
                      <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                      <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    <span>FAQ bearbeiten</span>
                  </a>
                  <a href="{% url 'get_index_text' %}" class="mks-navbar-manage-item">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                      <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    <span>Startseite</span>
                  </a>
                </div>
              </div>
              
              <!-- User Management Column - Only for Staff/Superuser -->
              {% if request.user.is_staff %}
              <div class="mks-navbar-manage-section">
                <h3>Benutzer & Anmeldungen</h3>
                <div class="mks-navbar-manage-items">
                  <a href="{% url 'get_controlling_students' %}" class="mks-navbar-manage-item">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                      <circle cx="9" cy="7" r="4"></circle>
                      <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                      <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <span>Schüler:innen</span>
                  </a>
                  <a href="{% url 'invitation:invitation_list' %}" class="mks-navbar-manage-item">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="9 11 12 14 22 4"></polyline>
                      <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                    </svg>
                    <span>Zusagen verwalten</span>
                  </a>
                  {% if request.user.is_superuser %}
                  <a href="/admin/users/customuser/" class="mks-navbar-manage-item">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                      <circle cx="9" cy="7" r="4"></circle>
                      <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                      <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <span>Benutzer verwalten</span>
                  </a>
                  <a href="{% url 'admin:auth_group_changelist' %}" class="mks-navbar-manage-item">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="12" cy="12" r="3"></circle>
                      <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                    <span>Rollen verwalten</span>
                  </a>
                  {% endif %}
                </div>
              </div>
              {% endif %}
              
              {% if request.user.coordinator %}
              <div class="mks-navbar-manage-section">
                <h3>Koordinator-Bereich</h3>
                <div class="mks-navbar-manage-items">
                  <a href="/team/controlling/coordinator/students?user_id={{ request.user.id }}" class="mks-navbar-manage-item">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                      <circle cx="9" cy="7" r="4"></circle>
                    </svg>
                    <span>Meine Schüler:innen</span>
                  </a>
                </div>
              </div>
              {% endif %}
              
              <!-- System & Events Column -->
              {% if request.user.is_staff %}
              <div class="mks-navbar-manage-section">
                <h3>System & Events</h3>
                <div class="mks-navbar-manage-items">
                  <a href="{% url 'event_managing_view' %}" class="mks-navbar-manage-item">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                      <line x1="16" y1="2" x2="16" y2="6"></line>
                      <line x1="8" y1="2" x2="8" y2="6"></line>
                      <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    <span>Veranstaltungen</span>
                  </a>
                  <a href="{% url 'gallery_admin' %}" class="mks-navbar-manage-item">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                      <circle cx="8.5" cy="8.5" r="1.5"></circle>
                      <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                    <span>Galerie verwalten</span>
                  </a>
                  <a href="/tanz-und-bewegung/wartung/" class="mks-navbar-manage-item">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M9 18V5l12-2v13"></path>
                      <circle cx="6" cy="18" r="3"></circle>
                      <circle cx="18" cy="16" r="3"></circle>
                    </svg>
                    <span>Tanz & Bewegung</span>
                  </a>
                </div>
              </div>
              {% endif %}
              
              <!-- Quick Stats & Actions Column -->
              <div class="mks-navbar-manage-section">
                <h3>Dashboard & Statistiken</h3>
                <div class="mks-navbar-manage-stats">
                  <div class="mks-navbar-manage-stat-card" id="new-registrations">
                    <div class="mks-navbar-manage-stat-icon">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                      </svg>
                    </div>
                    <div class="mks-navbar-manage-stat-content">
                      <span class="mks-navbar-manage-stat-number">--</span>
                      <span class="mks-navbar-manage-stat-label">Neue Anmeldungen (7T)</span>
                    </div>
                  </div>
                  
                  <div class="mks-navbar-manage-stat-card" id="website-visits">
                    <div class="mks-navbar-manage-stat-icon">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                      </svg>
                    </div>
                    <div class="mks-navbar-manage-stat-content">
                      <span class="mks-navbar-manage-stat-number">--</span>
                      <span class="mks-navbar-manage-stat-label">Seitenaufrufe (30T)</span>
                    </div>
                  </div>
                  
                  <div class="mks-navbar-manage-stat-card" id="recent-blogs">
                    <div class="mks-navbar-manage-stat-icon">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 20h9"></path>
                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                      </svg>
                    </div>
                    <div class="mks-navbar-manage-stat-content">
                      <span class="mks-navbar-manage-stat-number">--</span>
                      <span class="mks-navbar-manage-stat-label">Blog-Beiträge (30T)</span>
                    </div>
                  </div>
                  
                  <div class="mks-navbar-manage-stat-card" id="gallery-images">
                    <div class="mks-navbar-manage-stat-icon">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                      </svg>
                    </div>
                    <div class="mks-navbar-manage-stat-content">
                      <span class="mks-navbar-manage-stat-number">--</span>
                      <span class="mks-navbar-manage-stat-label">Galerie Bilder</span>
                    </div>
                  </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="mks-navbar-manage-quick-actions">
                  <a href="{% url 'create_blog_post' %}" class="mks-navbar-manage-quick-action">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M12 5l0 14"></path>
                      <path d="M5 12l14 0"></path>
                    </svg>
                    Neuer Blog-Post
                  </a>
                  {% if request.user.is_staff %}
                  <a href="{% url 'event_managing_view' %}" class="mks-navbar-manage-quick-action">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M12 5l0 14"></path>
                      <path d="M5 12l14 0"></path>
                    </svg>
                    Neue Veranstaltung
                  </a>
                  {% endif %}
                  <form method="post" action="{% url 'logout' %}" style="margin: 0;">
                    {% csrf_token %}
                    <button type="submit" class="mks-navbar-manage-quick-action" style="background: #dc2626; border: none; cursor: pointer; font-family: inherit;">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                      </svg>
                      Ausloggen
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Overlay Menu Integration -->
        {% include 'navigation/overlay_menu.html' %}
        
        <!-- User Profile Dropdown -->
        <div class="mks-navbar-manage-user">
          <button class="mks-navbar-manage-user-trigger">
            <span class="mks-navbar-manage-user-name">{{ request.user.get_full_name|default:request.user.username }}</span>
            <span class="mks-navbar-manage-user-role">
              {% if request.user.is_staff %}Administrator{% elif request.user.coordinator %}Koordinator{% else %}Benutzer{% endif %}
            </span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          
          <div class="mks-navbar-manage-user-menu">
            <div class="mks-navbar-manage-user-info">
              <strong>{{ request.user.get_full_name|default:request.user.username }}</strong>
              <span>{{ request.user.email }}</span>
            </div>
            <div class="mks-navbar-manage-user-actions">
              <a href="/admin/users/customuser/{{ request.user.id }}/change/" class="mks-navbar-manage-user-action">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                </svg>
                Profil bearbeiten
              </a>
              <a href="{% url 'change_password' %}" class="mks-navbar-manage-user-action">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="3"></circle>
                  <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
                Passwort ändern
              </a>
            </div>
            <div class="mks-navbar-manage-user-logout">
              <form method="post" action="{% url 'logout' %}">
                {% csrf_token %}
                <button type="submit" class="mks-navbar-manage-logout-btn">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                  </svg>
                  Ausloggen
                </button>
              </form>
            </div>
          </div>
        </div>
        
      </div>
    </div>
  </div>

  <!-- Mobile Navigation -->
  <div id="mks-nav-mobile" class="menu">
    <div class="mks-navbar-manage-mobile-header">
      <span id="menuIcon" onclick="openMksNavMenu()" aria-label="Menü öffnen">
        {% include "templates/svg/nav_bar_hamburger_mobile.html" %}
      </span>
    </div>
    <div class="mks-navbar-manage-mobile-logo">
      <a href="{% url 'home_view' %}" aria-label="Zur Startseite">
        <div id="small-mobile-logo" style="display: none;">
          {% include "templates/svg/nav_bar_mobile_logo.html" %}
        </div>
        <div id="medium-mobile-logo">
          {% include "templates/svg/nav_bar_icon.html" %}
        </div>
      </a>
    </div>
    <div class="mks-navbar-manage-mobile-indicator">
      {% if request.user.is_staff %}
      <span class="mks-navbar-manage-badge">Admin</span>
      {% elif request.user.coordinator %}
      <span class="mks-navbar-manage-badge">Koordinator</span>
      {% endif %}
    </div>
  </div>
  
  <!-- Mobile Menu Overlay -->
  <div id="mks-nav-mobile-menu" class="mks-navbar-manage-overlay">
    <div class="mks-navbar-manage-overlay-content">
      <!-- Close Button -->
      <a id="closeMobileMenu" href="javascript:void(0)" class="mks-navbar-manage-closebtn" onclick="closeMksNavMenu()" aria-label="Menü schließen">
        {% include "templates/svg/nav_bar_crossburger.html" %}
      </a>
      
      <!-- User Info -->
      <div class="mks-navbar-manage-mobile-user">
        <div class="mks-navbar-manage-mobile-avatar">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
        </div>
        <div class="mks-navbar-manage-mobile-user-info">
          <span class="mks-navbar-manage-mobile-name">{{ request.user.get_full_name|default:request.user.username }}</span>
          <span class="mks-navbar-manage-mobile-role">
            {% if request.user.is_staff %}Administrator{% elif request.user.coordinator %}Koordinator{% else %}Benutzer{% endif %}
          </span>
        </div>
      </div>
      
      <!-- Navigation Groups -->
      <div class="mks-navbar-manage-mobile-nav">
        
        <!-- Content Management Group -->
        <div class="mks-navbar-manage-mobile-group">
          <div class="mks-navbar-manage-mobile-group-header" data-toggle="content-group">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 20h9"></path>
              <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
            </svg>
            <span>Inhalte verwalten</span>
            <svg class="mks-navbar-manage-expand-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="mks-navbar-manage-mobile-items" id="content-group" style="display: none;">
            <a href="{% url 'show_blogs_editing' %}">Blog verwalten</a>
            <a href="{% url 'get_all_faqs' %}">FAQ bearbeiten</a>
            <a href="{% url 'get_index_text' %}">Startseite bearbeiten</a>
          </div>
        </div>
        
        <!-- User Management Group -->
        {% if request.user.is_staff %}
        <div class="mks-navbar-manage-mobile-group">
          <div class="mks-navbar-manage-mobile-group-header" data-toggle="user-group">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <span>Benutzer & Anmeldungen</span>
            <svg class="mks-navbar-manage-expand-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="mks-navbar-manage-mobile-items" id="user-group" style="display: none;">
            <a href="{% url 'get_controlling_students' %}">Schüler:innen verwalten</a>
            <a href="{% url 'invitation:invitation_list' %}">Zusagen verwalten</a>
            {% if request.user.is_superuser %}
            <a href="/admin/users/customuser/">Benutzer verwalten</a>
            <a href="{% url 'admin:auth_group_changelist' %}">Rollen verwalten</a>
            {% endif %}
          </div>
        </div>
        {% endif %}
        
        <!-- Coordinator Group -->
        {% if request.user.coordinator %}
        <div class="mks-navbar-manage-mobile-group">
          <a href="/team/controlling/coordinator/students?user_id={{ request.user.id }}" class="mks-navbar-manage-mobile-single">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
            </svg>
            <span>Meine Schüler:innen</span>
          </a>
        </div>
        {% endif %}
        
        <!-- System Group -->
        {% if request.user.is_staff %}
        <div class="mks-navbar-manage-mobile-group">
          <div class="mks-navbar-manage-mobile-group-header" data-toggle="system-group">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <span>System & Events</span>
            <svg class="mks-navbar-manage-expand-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="mks-navbar-manage-mobile-items" id="system-group" style="display: none;">
            <a href="{% url 'event_managing_view' %}">Veranstaltungen</a>
            <a href="{% url 'gallery_admin' %}">Galerie verwalten</a>
            <a href="/tanz-und-bewegung/wartung/">Tanz & Bewegung</a>
          </div>
        </div>
        {% endif %}
        
        <!-- Quick Actions Group -->
        <div class="mks-navbar-manage-mobile-group">
          <div class="mks-navbar-manage-mobile-group-header" data-toggle="quick-group">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <span>Schnellzugriff</span>
            <svg class="mks-navbar-manage-expand-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="mks-navbar-manage-mobile-items" id="quick-group" style="display: none;">
            <a href="{% url 'create_blog_post' %}">Neuer Blog-Post</a>
            {% if request.user.is_staff %}
            <a href="{% url 'event_managing_view' %}">Neue Veranstaltung</a>
            {% endif %}
          </div>
        </div>
        
      </div>
      
      <!-- Mobile Footer -->
      <div class="mks-navbar-manage-mobile-footer">
        <form method="post" action="{% url 'logout' %}">
          {% csrf_token %}
          <button type="submit" class="mks-navbar-manage-mobile-logout">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            Ausloggen
          </button>
        </form>
      </div>
    </div>
  </div>
</header>

<!-- Management Navigation JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Mega Dropdown Functionality
  const managementDropdown = document.querySelector('.mks-navbar-manage-dropdown');
  const megaDropdown = document.querySelector('.mks-navbar-manage-mega');
  const trigger = document.querySelector('.mks-navbar-manage-trigger');
  
  if (managementDropdown && megaDropdown) {
    let hideTimeout;
    
    // Show dropdown on hover
    managementDropdown.addEventListener('mouseenter', function() {
      clearTimeout(hideTimeout);
      megaDropdown.style.opacity = '1';
      megaDropdown.style.visibility = 'visible';
      megaDropdown.style.transform = 'translateX(-50%) translateY(0)';
      trigger.setAttribute('aria-expanded', 'true');
    });
    
    // Hide dropdown on leave
    managementDropdown.addEventListener('mouseleave', function() {
      hideTimeout = setTimeout(function() {
        megaDropdown.style.opacity = '0';
        megaDropdown.style.visibility = 'hidden';
        megaDropdown.style.transform = 'translateX(-50%) translateY(-10px)';
        trigger.setAttribute('aria-expanded', 'false');
      }, 150);
    });
    
    // Keep dropdown open when hovering over it
    megaDropdown.addEventListener('mouseenter', function() {
      clearTimeout(hideTimeout);
    });
    
    megaDropdown.addEventListener('mouseleave', function() {
      hideTimeout = setTimeout(function() {
        megaDropdown.style.opacity = '0';
        megaDropdown.style.visibility = 'hidden';
        megaDropdown.style.transform = 'translateX(-50%) translateY(-10px)';
        trigger.setAttribute('aria-expanded', 'false');
      }, 150);
    });
  }
  
  // Enhanced User Profile Dropdown - Simpler approach
  console.log('=== User Dropdown Debug ===');
  
  // Use a more generic selector approach
  const userTrigger = document.querySelector('button.mks-navbar-manage-user-trigger');
  const userMenu = document.querySelector('div.mks-navbar-manage-user-menu');
  const userContainer = document.querySelector('div.mks-navbar-manage-user');
  
  console.log('Elements found:', {
    userTrigger: userTrigger,
    userMenu: userMenu,
    userContainer: userContainer
  });
  
  if (userTrigger && userMenu) {
    // Simple toggle function
    function toggleUserMenu() {
      console.log('toggleUserMenu called');
      const isHidden = userMenu.style.display === 'none' || !userMenu.style.display;
      console.log('Current state - isHidden:', isHidden);
      
      if (isHidden) {
        userMenu.style.display = 'block';
        userMenu.style.visibility = 'visible';
        userMenu.style.opacity = '1';
        userTrigger.setAttribute('aria-expanded', 'true');
        console.log('Menu opened');
      } else {
        userMenu.style.display = 'none';
        userMenu.style.visibility = 'hidden';
        userMenu.style.opacity = '0';
        userTrigger.setAttribute('aria-expanded', 'false');
        console.log('Menu closed');
      }
    }
    
    // Add click event to trigger
    userTrigger.addEventListener('click', function(e) {
      console.log('User trigger button clicked');
      e.preventDefault();
      e.stopPropagation();
      toggleUserMenu();
    });
    
    // Close when clicking outside
    document.addEventListener('click', function(e) {
      if (userContainer && !userContainer.contains(e.target)) {
        userMenu.style.display = 'none';
        userMenu.style.visibility = 'hidden';
        userMenu.style.opacity = '0';
        userTrigger.setAttribute('aria-expanded', 'false');
        console.log('Menu closed by outside click');
      }
    });
    
    // Initial state
    userMenu.style.display = 'none';
    userTrigger.setAttribute('aria-expanded', 'false');
    
    console.log('User dropdown initialized successfully');
  } else {
    console.error('Failed to find user dropdown elements');
  }
  
  // System Status Check
  const systemStatusBtn = document.getElementById('system-status-check');
  if (systemStatusBtn) {
    systemStatusBtn.addEventListener('click', function(e) {
      e.preventDefault();
      
      // Show loading state
      const statusIndicator = this.querySelector('.mks-navbar-manage-status-indicator');
      statusIndicator.className = 'mks-navbar-manage-status-indicator loading';
      
      // Simulate API call (you can replace this with actual system status check)
      setTimeout(() => {
        statusIndicator.className = 'mks-navbar-manage-status-indicator online';
        
        // Show notification
        const notification = document.createElement('div');
        notification.className = 'mks-navbar-manage-notification';
        notification.innerHTML = `
          <div class="mks-navbar-manage-notification-content">
            <h4>System Status</h4>
            <p>✅ Alle Systeme laufen einwandfrei</p>
            <p>🔄 Letztes Backup: Heute 05:30 Uhr</p>
            <p>👥 Aktive Benutzer: 12</p>
            <button onclick="this.parentElement.parentElement.remove()">✕</button>
          </div>
        `;
        document.body.appendChild(notification);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
          if (notification.parentElement) {
            notification.remove();
          }
        }, 5000);
      }, 1000);
    });
  }
  
  // Load Dashboard Statistics
  function loadDashboardStats() {
    const statCards = {
      'new-registrations': { endpoint: '/api/stats/new-registrations', fallback: Math.floor(Math.random() * 15) + 5 },
      'website-visits': { endpoint: '/api/stats/website-visits', fallback: Math.floor(Math.random() * 500) + 1200 },
      'recent-blogs': { endpoint: '/api/stats/recent-blogs', fallback: Math.floor(Math.random() * 8) + 2 },
      'gallery-images': { endpoint: '/api/stats/gallery-images', fallback: Math.floor(Math.random() * 50) + 120 }
    };
    
    Object.entries(statCards).forEach(([id, config]) => {
      const card = document.getElementById(id);
      if (card) {
        const numberElement = card.querySelector('.mks-navbar-manage-stat-number');
        
        // Add loading state
        card.classList.add('loading');
        
        // Try to fetch real data, fallback to mock data
        fetch(config.endpoint, {
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
          },
          credentials: 'same-origin'
        })
        .then(response => {
          if (!response.ok) throw new Error('API not available');
          return response.json();
        })
        .then(data => {
          numberElement.textContent = data.count || data.value || config.fallback;
        })
        .catch(() => {
          // Use fallback data if API is not available
          setTimeout(() => {
            numberElement.textContent = config.fallback.toLocaleString();
          }, Math.random() * 1000 + 500); // Random delay to simulate loading
        })
        .finally(() => {
          setTimeout(() => {
            card.classList.remove('loading');
          }, 800);
        });
        
        // Add click handler for more details
        card.addEventListener('click', function() {
          let detailUrl = '';
          switch(id) {
            case 'new-registrations':
              detailUrl = '{% url "get_controlling_students" %}';
              break;
            case 'website-visits':
              showStatsModal('Website-Besucher', 'Detaillierte Statistiken über Seitenaufrufe sind über Google Analytics verfügbar.');
              return;
            case 'recent-blogs':
              detailUrl = '{% url "show_blogs_editing" %}';
              break;
            case 'gallery-images':
              detailUrl = '{% url "gallery_admin" %}';
              break;
          }
          if (detailUrl) {
            window.location.href = detailUrl;
          }
        });
      }
    });
  }
  
  // Show stats modal
  function showStatsModal(title, content) {
    const modal = document.createElement('div');
    modal.className = 'mks-navbar-manage-notification';
    modal.innerHTML = `
      <div class="mks-navbar-manage-notification-content">
        <h4>${title}</h4>
        <p>${content}</p>
        <button onclick="this.parentElement.parentElement.remove()">Schließen</button>
      </div>
    `;
    document.body.appendChild(modal);
    
    setTimeout(() => {
      if (modal.parentElement) {
        modal.remove();
      }
    }, 10000);
  }
  
  // Load stats when dropdown is opened
  if (managementDropdown) {
    let statsLoaded = false;
    managementDropdown.addEventListener('mouseenter', function() {
      if (!statsLoaded) {
        loadDashboardStats();
        statsLoaded = true;
      }
    });
  }
  
  // Mobile Navigation Groups Toggle
  const mobileGroupHeaders = document.querySelectorAll('.mks-navbar-manage-mobile-group-header');
  mobileGroupHeaders.forEach(header => {
    const toggleId = header.getAttribute('data-toggle');
    if (toggleId) {
      header.addEventListener('click', function() {
        const targetGroup = document.getElementById(toggleId);
        const expandIcon = header.querySelector('.mks-navbar-manage-expand-icon');
        
        if (targetGroup && expandIcon) {
          const isVisible = targetGroup.style.display === 'block';
          if (isVisible) {
            targetGroup.style.display = 'none';
            expandIcon.style.transform = 'rotate(0deg)';
            header.classList.remove('active');
          } else {
            targetGroup.style.display = 'block';
            expandIcon.style.transform = 'rotate(180deg)';
            header.classList.add('active');
          }
        }
      });
    }
  });
  
  // Active link highlighting
  const currentPath = window.location.pathname;
  const navLinks = document.querySelectorAll('.mks-navbar-manage-item[href], .mks-navbar-manage-mobile-items a');
  
  navLinks.forEach(link => {
    if (link.getAttribute('href') === currentPath) {
      link.classList.add('active');
    }
  });
});

// Mobile Navigation Functions (keeping backward compatibility)
function openMksNavMenu() {
  const overlay = document.getElementById('mks-nav-mobile-menu');
  if (overlay) {
    overlay.style.width = '100vw';
    overlay.style.height = '100vh';
    document.body.style.overflow = 'hidden';
  }
}

function closeMksNavMenu() {
  const overlay = document.getElementById('mks-nav-mobile-menu');
  if (overlay) {
    overlay.style.width = '0';
    overlay.style.height = '0';
    document.body.style.overflow = '';
  }
}

// Legacy compatibility (for older mobile nav functions)
function openNav() {
  openMksNavMenu();
}

function closeNav() {
  closeMksNavMenu();
}
</script>

<!-- Overlay Menu JavaScript -->
<script src="{% static 'js/navigation/overlay_menu.js' %}"></script>
