{% load static %}

<!-- MKS Enhanced User Navigation - Optimized Version 2.0 -->
<link rel="stylesheet" href="{% static 'css/admin_nav.3.0.1.css' %}">

<!-- Main User Navigation Header -->
<header id="UserNav" role="banner">
  <div class="mks-navbar-manage-container">
    
    <!-- Logo Section -->
    <div class="mks-navbar-manage-logo">
      <a href="{% if request.user.is_authenticated %}/team{% else %}{% url 'home_view' %}{% endif %}" aria-label="{% if request.user.is_authenticated %}Zum Team-Bereich{% else %}Zur MKS Startseite{% endif %}">
        {% include "templates/svg/nav_bar_icon.html" %}
      </a>
    </div>
    
    <!-- Navigation Section -->
    <div class="mks-navbar-manage-nav">
      <div class="mks-navbar-manage-actions">
        
        <!-- Integration des neuen Overlay-Menüs -->
        {% include 'navigation/mks_overlay_menu.html' %}
        
      </div>
    </div>
    
  </div>

  <!-- Mobile Navigation -->
  <div id="mks-nav-mobile" class="menu" role="navigation" aria-label="Mobile Navigation">
    <div class="mks-navbar-manage-mobile-header">
      <button id="menuIcon" 
              onclick="toggleMobileMenu()" 
              aria-label="Mobile Menü öffnen"
              aria-expanded="false"
              aria-controls="mks-nav-mobile-menu">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
    
    <div class="mks-navbar-manage-mobile-logo">
      <a href="{% if request.user.is_authenticated %}/team{% else %}{% url 'home_view' %}{% endif %}" aria-label="{% if request.user.is_authenticated %}Zum Team-Bereich{% else %}Zur MKS Startseite{% endif %}">
        <div id="small-mobile-logo" style="display: none;">
          {% include "templates/svg/nav_bar_mobile_logo.html" %}
        </div>
        <div id="medium-mobile-logo">
          {% include "templates/svg/nav_bar_icon.html" %}
        </div>
      </a>
    </div>
    
    <div class="mks-navbar-manage-mobile-indicator">
      {% if request.user.is_superuser %}
      <span class="mks-navbar-manage-badge">Admin</span>
      {% elif request.user.is_staff %}
      <span class="mks-navbar-manage-badge">Staff</span>
      {% elif request.user.coordinator %}
      <span class="mks-navbar-manage-badge">Koordinator</span>
      {% endif %}
    </div>
  </div>
  
  <!-- Mobile Menu Overlay -->
  <div id="mks-nav-mobile-menu" 
       class="mks-navbar-manage-overlay" 
       role="dialog" 
       aria-modal="true"
       aria-hidden="true"
       aria-labelledby="mobile-menu-title">
    
    <div class="mks-navbar-manage-overlay-content">
      
      <!-- REMOVED Close Button - Hamburger now transforms -->
      <!-- 
      <button id="closeMobileMenu" 
              class="mks-navbar-manage-closebtn" 
              onclick="closeMksNavMenu()" 
              aria-label="Mobile Menü schließen">
        {% include "templates/svg/nav_bar_crossburger.html" %}
      </button>
      -->
      
      <h2 id="mobile-menu-title" class="sr-only">Mobile Navigation</h2>
      
      <!-- User Info -->
      <div class="mks-navbar-manage-mobile-user">
        <div class="mks-navbar-manage-mobile-avatar" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
        </div>
        <div class="mks-navbar-manage-mobile-user-info">
          <span class="mks-navbar-manage-mobile-name">{{ request.user.get_full_name|default:request.user.username }}</span>
          <span class="mks-navbar-manage-mobile-role">
            {% if request.user.is_superuser %}Administrator
            {% elif request.user.is_staff %}Staff
            {% elif request.user.coordinator %}Koordinator
            {% else %}Benutzer
            {% endif %}
          </span>
        </div>
      </div>
      
      <!-- Navigation Groups -->
      <nav class="mks-navbar-manage-mobile-nav" aria-label="Mobile Hauptnavigation">
        
        <!-- Content Management Group -->
        <div class="mks-navbar-manage-mobile-group">
          <button class="mks-navbar-manage-mobile-group-header" 
                  data-toggle="content-group"
                  aria-expanded="false"
                  aria-controls="content-group">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M12 20h9"></path>
              <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
            </svg>
            <span>Inhalte verwalten</span>
            <svg class="mks-navbar-manage-expand-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          <div class="mks-navbar-manage-mobile-items" id="content-group" style="display: none;">
            <a href="{% url 'show_blogs_editing' %}">Blog verwalten</a>
            <a href="{% url 'get_all_faqs' %}">FAQ bearbeiten</a>
            <a href="{% url 'controlling:get_index_text' %}">Startseite bearbeiten</a>
          </div>
        </div>
        
        <!-- User Management Group -->
        {% if request.user.is_staff %}
        <div class="mks-navbar-manage-mobile-group">
          <button class="mks-navbar-manage-mobile-group-header" 
                  data-toggle="user-group"
                  aria-expanded="false"
                  aria-controls="user-group">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <span>Benutzer & Anmeldungen</span>
            <svg class="mks-navbar-manage-expand-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          <div class="mks-navbar-manage-mobile-items" id="user-group" style="display: none;">
            <a href="{% url 'controlling:get_controlling_students' %}">Schüler:innen verwalten</a>
            <a href="{% url 'invitation:invitation_list' %}">Zusagen verwalten</a>
            {% if request.user.is_superuser %}
            <a href="/admin/users/customuser/">Benutzer verwalten</a>
            <a href="{% url 'admin:auth_group_changelist' %}">Rollen verwalten</a>
            {% endif %}
          </div>
        </div>
        {% endif %}
        
        <!-- Coordinator Group -->
        {% if request.user.coordinator %}
        <div class="mks-navbar-manage-mobile-group">
          <a href="/team/controlling/coordinator/students?user_id={{ request.user.id }}" 
             class="mks-navbar-manage-mobile-single">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
            </svg>
            <span>Meine Schüler:innen</span>
          </a>
        </div>
        {% endif %}
        
        <!-- System Group -->
        {% if request.user.is_staff %}
        <div class="mks-navbar-manage-mobile-group">
          <button class="mks-navbar-manage-mobile-group-header" 
                  data-toggle="system-group"
                  aria-expanded="false"
                  aria-controls="system-group">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <span>System & Events</span>
            <svg class="mks-navbar-manage-expand-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          <div class="mks-navbar-manage-mobile-items" id="system-group" style="display: none;">
            <a href="{% url 'users:event_managing_view' %}">Veranstaltungen</a>
            <a href="{% url 'gallery_admin' %}">Galerie verwalten</a>
            <a href="/tanz-und-bewegung/wartung/">Tanz & Bewegung</a>
          </div>
        </div>
        {% endif %}
        
        <!-- Quick Actions Group -->
        <div class="mks-navbar-manage-mobile-group">
          <button class="mks-navbar-manage-mobile-group-header" 
                  data-toggle="quick-group"
                  aria-expanded="false"
                  aria-controls="quick-group">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <span>Schnellzugriff</span>
            <svg class="mks-navbar-manage-expand-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          <div class="mks-navbar-manage-mobile-items" id="quick-group" style="display: none;">
            <a href="{% url 'create_blog_post' %}">Neuer Blog-Post</a>
            {% if request.user.is_staff %}
            <a href="{% url 'users:event_managing_view' %}">Neue Veranstaltung</a>
            {% endif %}
          </div>
        </div>
      </nav>
      
      <!-- Mobile Footer with Logout -->
      <div class="mks-navbar-manage-mobile-footer">
        <form method="post" action="{% url 'users:logout' %}">
          {% csrf_token %}
          <button type="submit" 
                  class="mks-navbar-manage-mobile-logout"
                  aria-label="Vom System abmelden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1-2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            Ausloggen
          </button>
        </form>
      </div>
      
    </div>
  </div>
</header>

<!-- Enhanced Mobile Navigation JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {

  // Combined function to toggle mobile menu and hamburger icon state
  function toggleMobileMenu() {
    const menuButton = document.getElementById('menuIcon');
    const mobileMenuOverlay = document.getElementById('mks-nav-mobile-menu');

    // Toggle the 'is-active' class on the button
    const isActive = menuButton.classList.toggle('is-active');

    if (isActive) {
        // Open the menu
        mobileMenuOverlay.style.width = "100%"; 
        mobileMenuOverlay.setAttribute('aria-hidden', 'false');
        menuButton.setAttribute('aria-expanded', 'true');
        menuButton.setAttribute('aria-label', 'Mobile Menü schließen');
        // Optional: Trap focus within the menu
    } else {
        // Close the menu
        mobileMenuOverlay.style.width = "0";
        mobileMenuOverlay.setAttribute('aria-hidden', 'true');
        menuButton.setAttribute('aria-expanded', 'false');
        menuButton.setAttribute('aria-label', 'Mobile Menü öffnen');
        // Optional: Return focus to the menu button
    }
  }

  // Make the function globally accessible if needed by onclick attributes directly
  // (though it's better if event listeners are attached in JS, for this setup it's fine)
  window.toggleMobileMenu = toggleMobileMenu; 

  /* Legacy compatibility - commented out as openMksNavMenu/closeMksNavMenu are removed
  window.openNav = window.openMksNavMenu;
  window.closeNav = window.closeMksNavMenu;
  */

  // Accordion functionality for mobile menu groups
  const groupHeaders = document.querySelectorAll('.mks-navbar-manage-mobile-group-header');
  groupHeaders.forEach(header => {
    const toggleId = header.getAttribute('data-toggle');
    const targetGroup = document.getElementById(toggleId);
    const expandIcon = header.querySelector('.mks-navbar-manage-expand-icon');
    
    if (targetGroup && expandIcon) {
      header.addEventListener('click', function() {
        const isVisible = targetGroup.style.display === 'block';
        const isExpanded = header.getAttribute('aria-expanded') === 'true';
        
        if (isVisible) {
          targetGroup.style.display = 'none';
          expandIcon.style.transform = 'rotate(0deg)';
          header.classList.remove('active');
          header.setAttribute('aria-expanded', 'false');
        } else {
          targetGroup.style.display = 'block';
          expandIcon.style.transform = 'rotate(180deg)';
          header.classList.add('active');
          header.setAttribute('aria-expanded', 'true');
        }
      });
    }
  });

  // Close mobile menu on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const overlay = document.getElementById('mks-nav-mobile-menu');
      if (overlay && overlay.style.width === '100%') {
        toggleMobileMenu();
      }
    }
  });

  // Active link highlighting
  const currentPath = window.location.pathname;
  const navLinks = document.querySelectorAll('.mks-navbar-manage-mobile-items a, .mks-overlay-nav-item[href]');
  
  navLinks.forEach(link => {
    if (link.getAttribute('href') === currentPath) {
      link.classList.add('active');
    }
  });

  // Smooth scroll behavior for navbar
  let lastScrollTop = 0;
  const navbar = document.getElementById('UserNav');
  
  if (navbar) {
    window.addEventListener('scroll', function() {
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      document.documentElement.setAttribute('data-scroll', scrollTop);
      lastScrollTop = scrollTop;
    }, { passive: true });
  }

  // Initialize scroll state
  document.documentElement.setAttribute('data-scroll', window.pageYOffset || 0);
});
</script>
