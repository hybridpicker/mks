{% extends "templates/base.html" %}

{% load static %}
{% block extra_head %}
<style>
  :root {
    --primary-color: #2563eb;
    --secondary-color: #64748b;
    --success-color: #10b981;
    --danger-color: #ef4444;
    --border-color: #e5e7eb;
    --background-color: #f9fafb;
    --text-color: #111827;
    --text-muted: #6b7280;
  }

  /* Scoped box-sizing to blog editor only */
  .blog-editor *, 
  .blog-editor *::before, 
  .blog-editor *::after {
    box-sizing: border-box;
  }

  body {
    background-color: var(--background-color);
    color: var(--text-color);
  }

  .blog-editor {
    max-width: 900px;
    margin: 0 auto;
    padding: 40px 20px;
  }

  .editor-header {
    margin-bottom: 40px;
  }

  .editor-header h1 {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-color);
    margin: 0;
  }

  .form-section {
    background: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    border: 1px solid var(--border-color);
  }

  .form-section h2 {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0 0 20px 0;
    color: var(--text-color);
  }
  
  /* Gallery Styles */
  .gallery-formset {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-top: 20px;
  }
  
  .gallery-item {
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 16px;
    position: relative;
    background-color: var(--background-color);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .gallery-item.marked-for-deletion {
    opacity: 0.5;
    transform: scale(0.98);
    border-color: var(--danger-color);
    background-color: #fef2f2;
  }
  
  .gallery-item:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    transform: translateY(-1px);
  }
  
  .gallery-item.marked-for-deletion:hover {
    transform: scale(0.98) translateY(-1px);
  }
  
  .gallery-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    position: relative;
  }
  
  .gallery-item-title {
    font-weight: 500;
    font-size: 1rem;
    flex: 1;
  }
  
  .gallery-form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 12px;
  }
  
  .gallery-preview {
    max-width: 150px;
    max-height: 150px;
    margin-top: 8px;
    border-radius: 4px;
    object-fit: cover;
  }
  
  .gallery-delete-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    flex-shrink: 0;
  }
  
  .gallery-delete-container input[type="checkbox"] {
    display: none;
  }
  
  .gallery-delete-btn {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    border: 1px solid #fca5a5;
    color: var(--danger-color);
    width: 36px;
    height: 36px;
    min-width: 36px;
    min-height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    padding: 0;
    margin: 0;
    line-height: 1;
    font-size: 0;
    font-weight: 600;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    text-decoration: none;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
    position: relative;
    overflow: hidden;
    vertical-align: middle;
    box-sizing: border-box;
  }
  
  /* Zusätzliche Sicherheit für perfekte Zentrierung */
  .gallery-delete-btn::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 0;
    height: 0;
    pointer-events: none;
  }
  
  .gallery-delete-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transition: left 0.5s;
  }
  
  .gallery-delete-btn:hover::before {
    left: 100%;
  }
  
  .gallery-delete-btn:hover {
    background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);
    color: white;
    border-color: #dc2626;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3), 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  
  .gallery-delete-btn:active {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2), 0 1px 2px rgba(0, 0, 0, 0.1);
  }
  
  .gallery-delete-btn svg {
    width: 90%;
    height: 90%;
    transition: transform 0.2s;
    display: block;
    flex-shrink: 0;
    pointer-events: none;
    margin: auto;
  }
  
  .gallery-delete-btn:hover svg {
    transform: scale(1.1);
  }
  
  .gallery-delete-text {
    font-size: 0.75rem;
    color: var(--text-muted);
    font-weight: 500;
    white-space: nowrap;
  }
  
  .gallery-delete-btn:hover + .gallery-delete-text {
    color: var(--danger-color);
  }
  
  /* Mobile responsive */
  @media (max-width: 640px) {
    .gallery-delete-container {
      top: 4px;
      right: 4px;
      gap: 2px;
    }
    
    .gallery-delete-btn {
      width: 32px;
      height: 32px;
      min-width: 32px;
      min-height: 32px;
    }
    
    .gallery-delete-btn svg {
      width: 18px;
      height: 18px;
    }
    
    .gallery-delete-text {
      font-size: 0.65rem;
    }
  }
  
  .gallery-add-btn {
    margin-top: 16px;
    background-color: white;
    border: 1px dashed var(--primary-color);
    color: var(--primary-color);
    border-radius: 8px;
    padding: 12px;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .gallery-add-btn:hover {
    background-color: var(--background-color);
  }
  
  .gallery-add-btn svg {
    margin-right: 8px;
    width: 20px;
    height: 20px;
  }
  
  .empty-gallery-message {
    text-align: center;
    padding: 32px;
    background-color: var(--background-color);
    border-radius: 8px;
    border: 1px dashed var(--border-color);
    color: var(--text-muted);
  }
  
  .empty-gallery-message svg {
    width: 48px;
    height: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
  }
  
  /* Gallery dropzone styles */
  .gallery-dropzone {
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    padding: 30px;
    text-align: center;
    transition: all 0.3s;
    background-color: var(--background-color);
    margin-bottom: 24px;
    cursor: pointer;
  }
  
  .gallery-dropzone.dragover {
    background-color: #f0f9ff;
    border-color: var(--primary-color);
    transform: scale(1.02);
  }
  
  .dropzone-icon {
    width: 48px;
    height: 48px;
    margin: 0 auto 16px;
    opacity: 0.5;
    color: var(--primary-color);
  }
  
  .dropzone-text {
    color: var(--text-color);
    font-size: 1rem;
    margin-bottom: 8px;
  }
  
  /* Upload progress */
  .upload-progress {
    margin-top: 20px;
    display: none;
  }
  
  .progress-bar-container {
    width: 100%;
    height: 8px;
    background-color: var(--border-color);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 8px;
  }
  
  .progress-bar {
    height: 100%;
    background-color: var(--primary-color);
    width: 0;
    transition: width 0.3s;
  }
  
  .progress-text {
    font-size: 0.875rem;
    color: var(--text-muted);
    text-align: center;
  }
  
  @media (max-width: 768px) {
    .gallery-form-row {
      grid-template-columns: 1fr;
    }
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-section label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-color);
    margin-bottom: 8px;
  }

  .form-control {
    width: 100%;
    max-width: 100%;
    padding: 10px 14px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 0.875rem;
    transition: all 0.2s;
    background-color: white;
    box-sizing: border-box;
    font-family: inherit;
  }

  .form-control:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  input[type="text"].form-control,
  input[type="email"].form-control,
  input[type="url"].form-control,
  input[type="password"].form-control,
  input[type="date"].form-control,
  input[type="time"].form-control,
  input[type="number"].form-control {
    height: 44px;
    line-height: 1.5;
  }

  textarea.form-control {
    resize: vertical;
    min-height: 100px;
    line-height: 1.5;
  }

  .blog-editor select.form-control,
  .blog-editor form select.form-control {
    height: 44px !important;
    cursor: pointer !important;
    appearance: none !important;
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e") !important;
    background-repeat: no-repeat !important;
    background-position: right 10px center !important;
    background-size: 16px 12px !important;
    padding-right: 40px !important;
  }
  
  /* Fix for any double arrow issues */
  .blog-editor select::-ms-expand {
    display: none !important;
  }

  /* Prevent input overflow on small screens */
  @media (max-width: 480px) {
    .form-control {
      font-size: 16px; /* Prevents zoom on iOS */
    }
    
    .blog-editor select.form-control,
    .blog-editor form select.form-control {
      font-size: 16px !important;
      background-size: 14px 10px !important;
      padding-right: 35px !important;
    }
  }

  .help-text {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 4px;
  }

  .error-message {
    color: var(--danger-color);
    font-size: 0.75rem;
    margin-top: 4px;
  }

  .form-check {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 16px 0;
  }

  .form-check-input {
    width: 20px;
    height: 20px;
    border: 2px solid var(--border-color);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .form-check-input:checked {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
  }

  .form-check label {
    cursor: pointer;
    font-weight: 400;
    margin: 0;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  .form-actions {
    display: flex;
    gap: 12px;
    justify-content: space-between;
    align-items: center;
    margin-top: 40px;
    padding-top: 24px;
    border-top: 1px solid var(--border-color);
  }

  .form-actions-left {
    display: flex;
    gap: 12px;
  }

  .form-actions-right {
    display: flex;
    gap: 12px;
  }

  .blog-editor .btn,
  .blog-editor form button,
  .blog-editor a.btn,
  .blog-editor button.btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    position: relative;
    overflow: hidden;
    background-color: transparent;
    color: inherit;
    /* Override the global button styles */
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif !important;
    width: auto !important;
    height: auto !important;
    background-image: none !important;
  }

  .blog-editor .btn:before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.2);
    transition: left 0.3s;
  }

  .blog-editor .btn:hover:before {
    left: 100%;
  }

  .blog-editor .btn svg {
    width: 18px;
    height: 18px;
  }

  .blog-editor .btn-primary,
  .blog-editor form button.btn-primary,
  .blog-editor a.btn-primary,
  .blog-editor button.btn-primary {
    background: unset !important;
    background-color: var(--primary-color) !important;
    background-image: none !important;
    color: white !important;
  }

  .blog-editor .btn-primary:hover {
    background-color: #1d4ed8 !important;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
  }

  .blog-editor .btn-secondary,
  .blog-editor form button.btn-secondary,
  .blog-editor a.btn-secondary,
  .blog-editor button.btn-secondary {
    background: white !important;
    background-image: none !important;
    color: var(--secondary-color) !important;
    border: 1px solid var(--border-color) !important;
  }

  .blog-editor .btn-secondary:hover {
    background-color: var(--background-color) !important;
    border-color: var(--secondary-color) !important;
  }

  .blog-editor .btn-success,
  .blog-editor form button.btn-success,
  .blog-editor a.btn-success,
  .blog-editor button.btn-success {
    background: unset !important;
    background-color: var(--success-color) !important;
    background-image: none !important;
    color: white !important;
  }

  .blog-editor .btn-success:hover {
    background-color: #059669 !important;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
  }

  .blog-editor .btn-danger,
  .blog-editor form button.btn-danger,
  .blog-editor a.btn-danger,
  .blog-editor button.btn-danger {
    background: white !important;
    background-image: none !important;
    color: var(--danger-color) !important;
    border: 1px solid var(--danger-color) !important;
  }

  .blog-editor .btn-danger:hover {
    background-color: var(--danger-color) !important;
    color: white !important;
    transform: translateY(-1px);
  }

  .blog-editor .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
  }

  .image-preview {
    margin-top: 16px;
    max-width: 400px;
  }

  .image-preview img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    border: 1px solid var(--border-color);
  }

  .image-preview p {
    font-size: 0.875rem;
    color: var(--text-muted);
    margin-bottom: 8px;
  }

  .char-counter {
    text-align: right;
    color: var(--text-muted);
    font-size: 0.75rem;
    margin-top: 4px;
  }

  .char-counter.warning {
    color: var(--danger-color);
  }

  .editor-status-bar {
    position: fixed;
    top: 20px;
    right: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    background: white;
    padding: 8px 16px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--border-color);
    z-index: 100;
  }

  .status-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.875rem;
  }

  .status-indicator .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: var(--text-muted);
  }

  .status-indicator.saved .dot {
    background-color: var(--success-color);
  }

  .status-indicator.saving .dot {
    background-color: var(--warning-color);
    animation: pulse 1s infinite;
  }

  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
  }

  .editor-quick-actions {
    position: fixed;
    bottom: 24px;
    right: 24px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .quick-action-btn,
  .editor-quick-actions button.quick-action-btn {
    width: 48px !important;
    height: 48px !important;
    border-radius: 50%;
    background: white !important;
    background-image: none !important;
    border: 1px solid var(--border-color);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    font-family: inherit !important;
    font-size: inherit !important;
    padding: 0 !important;
  }

  .quick-action-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .quick-action-btn svg {
    width: 24px;
    height: 24px;
    color: var(--secondary-color);
  }

  .quick-action-btn.primary,
  .editor-quick-actions button.quick-action-btn.primary {
    background-color: var(--primary-color) !important;
    border-color: var(--primary-color) !important;
  }

  .quick-action-btn.primary svg {
    color: white;
  }

  /* Minimal TinyMCE styling */
  .tox-tinymce {
    border: 1px solid var(--border-color) !important;
    border-radius: 8px !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
  }

  .tox .tox-edit-area {
    border-top: 1px solid var(--border-color) !important;
  }

  .tox .tox-edit-area__iframe {
    background: white !important;
  }

  /* Hide TinyMCE promotion link */
  .tox-promotion-link,
  .tox-statusbar__branding,
  .tox .tox-statusbar__upgrade {
    display: none !important;
  }

  .mce-content-body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    font-size: 0.875rem;
    line-height: 1.6;
    padding: 16px !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
  }

  /* Ensure TinyMCE toolbar wraps properly */
  .tox .tox-toolbar__primary {
    flex-wrap: wrap !important;
  }

  /* Image upload area */
  .file-upload-area {
    position: relative;
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    transition: all 0.2s;
    background-color: var(--background-color);
    overflow: hidden;
    max-width: 100%;
  }

  .file-upload-area:hover {
    border-color: var(--primary-color);
    background-color: #f0f9ff;
  }

  .file-upload-area input[type="file"] {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
  }

  .file-upload-text {
    color: var(--text-muted);
    font-size: 0.875rem;
    pointer-events: none;
  }

  .file-upload-icon {
    width: 40px;
    height: 40px;
    margin: 0 auto 12px;
    opacity: 0.4;
    pointer-events: none;
  }

  /* Responsive design */
  @media (max-width: 768px) {
    .blog-editor {
      padding: 20px 15px;
    }
    
    .form-section {
      padding: 16px;
    }
    
    .form-row {
      grid-template-columns: 1fr;
    }
    
    .form-actions {
      flex-direction: column;
      gap: 16px;
    }
    
    .form-actions-left,
    .form-actions-right {
      width: 100%;
      flex-direction: column;
    }
    
    .blog-editor .btn {
      width: 100%;
      justify-content: center;
    }
    
    .editor-status-bar {
      top: auto;
      bottom: 20px;
      left: 20px;
      right: 20px;
    }
    
    .editor-quick-actions {
      display: none;
    }
  }

  /* Debug overlay styles */
  #debug-overlay {
    position: fixed !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    background: rgba(0, 0, 0, 0.95) !important;
    color: white !important;
    padding: 25px !important;
    border-radius: 15px !important;
    max-width: 90% !important;
    max-height: 90% !important;
    overflow: auto !important;
    z-index: 99999 !important;
    font-family: 'Courier New', monospace !important;
    font-size: 13px !important;
    line-height: 1.5 !important;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8) !important;
    border: 2px solid #4ecdc4 !important;
  }
  
  #debug-overlay h3 {
    color: #ff6b6b !important;
    margin-top: 0 !important;
    text-align: center !important;
    font-size: 18px !important;
  }
  
  #debug-overlay button {
    background: #4ecdc4 !important;
    color: white !important;
    border: none !important;
    padding: 12px 24px !important;
    border-radius: 6px !important;
    cursor: pointer !important;
    font-weight: bold !important;
    transition: all 0.2s !important;
  }
  
  #debug-overlay button:hover {
    background: #45b7aa !important;
    transform: translateY(-1px) !important;
  }
  
  #debug-overlay button.continue-btn {
    background: #ff6b6b !important;
    margin-left: 10px !important;
  }
  
  #debug-overlay button.continue-btn:hover {
    background: #ff5252 !important;
  }
  
  /* Real-time validation indicators */
  .form-group {
    position: relative;
  }
  
  .validation-indicator {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 18px;
    z-index: 10;
  }
  
  .validation-indicator.valid {
    color: #4ecdc4;
  }
  
  .validation-indicator.invalid {
    color: #ff6b6b;
  }
  
  .char-counter.live {
    position: absolute;
    right: 10px;
    bottom: -20px;
    font-size: 11px;
    color: #666;
  }
  
  .char-counter.live.warning {
    color: #ff6b6b;
    font-weight: bold;
  }

  /* Error Alert Styles */
  .error-alert {
    position: fixed;
    top: 20px;
    right: 20px;
    left: 20px;
    max-width: 600px;
    margin: 0 auto;
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    border: 1px solid #f87171;
    border-radius: 12px;
    padding: 16px 20px;
    box-shadow: 0 10px 25px rgba(248, 113, 113, 0.2);
    z-index: 10000;
    opacity: 0;
    transform: translateY(-20px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .error-alert.show {
    opacity: 1;
    transform: translateY(0);
  }
  
  .error-alert-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }
  
  .error-alert-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: #dc2626;
    font-size: 1rem;
  }
  
  .error-alert-close {
    background: none;
    border: none;
    color: #dc2626;
    cursor: pointer;
    padding: 4px;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
  }
  
  .error-alert-close:hover {
    background-color: rgba(220, 38, 38, 0.1);
  }
  
  .error-alert-content {
    color: #991b1b;
    font-size: 0.875rem;
    line-height: 1.5;
  }
  
  .error-list {
    margin: 8px 0 0 0;
    padding-left: 20px;
  }
  
  .error-list li {
    margin-bottom: 4px;
  }
  
  /* Success Alert Styles */
  .success-alert {
    position: fixed;
    top: 20px;
    right: 20px;
    left: 20px;
    max-width: 600px;
    margin: 0 auto;
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    border: 1px solid #34d399;
    border-radius: 12px;
    padding: 16px 20px;
    box-shadow: 0 10px 25px rgba(52, 211, 153, 0.2);
    z-index: 10000;
    opacity: 0;
    transform: translateY(-20px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .success-alert.show {
    opacity: 1;
    transform: translateY(0);
  }
  
  .success-alert-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: #065f46;
    font-size: 1rem;
  }
  
  .success-alert-content {
    color: #047857;
    font-size: 0.875rem;
    margin-top: 8px;
  }
  
  /* Loading Overlay */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255, 255, 255, 0.9);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }
  
  .loading-overlay.show {
    opacity: 1;
    visibility: visible;
  }
  
  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border-color);
    border-top-color: var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 16px;
  }
  
  .loading-text {
    color: var(--text-color);
    font-size: 1rem;
    font-weight: 500;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  /* Mobile responsiveness for alerts */
  @media (max-width: 640px) {
    .error-alert,
    .success-alert {
      top: 10px;
      right: 10px;
      left: 10px;
      padding: 12px 16px;
    }
    
    .error-alert-title,
    .success-alert-title {
      font-size: 0.875rem;
    }
    
    .error-alert-content,
    .success-alert-content {
      font-size: 0.8rem;
    }
  }

  /* Ensure all content stays within bounds */
  .blog-editor * {
    max-width: 100%;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  /* Prevent horizontal scrolling */
  html, body {
    overflow-x: hidden;
  }

  /* Loading state */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    display: none;
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border-color);
    border-top-color: var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  .bs{
    height: 0 !important;
  }
</style>
{{ form.media }}
{% endblock %}

{% block navbar %}
{% endblock %}

{% block banner %}
{% endblock %}

{% block body %}
<!-- Error Alert -->
<div id="error-alert" class="error-alert">
  <div class="error-alert-header">
    <div class="error-alert-title">
      <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
      </svg>
      Error
    </div>
    <button type="button" class="error-alert-close" onclick="hideErrorAlert()">
      <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
      </svg>
    </button>
  </div>
  <div class="error-alert-content" id="error-alert-content">
    <!-- Error message will be inserted here -->
  </div>
</div>

<!-- Success Alert -->
<div id="success-alert" class="success-alert">
  <div class="success-alert-title">
    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
    </svg>
    Success
  </div>
  <div class="success-alert-content" id="success-alert-content">
    <!-- Success message will be inserted here -->
  </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay">
  <div class="loading-spinner"></div>
  <div class="loading-text">Saving your blog post...</div>
</div>

<div class="blog-editor">
  <!-- Status Bar -->
  <div class="editor-status-bar">
    <div class="status-indicator" id="save-status">
      <span class="dot"></span>
      <span class="status-text">Ready</span>
    </div>
    {% if form.instance.pk %}
    <div class="status-indicator">
      {% if form.instance.published %}
      <span class="dot" style="background-color: var(--success-color);"></span>
      <span>Published</span>
      {% else %}
      <span class="dot" style="background-color: var(--warning-color);"></span>
      <span>Draft</span>
      {% endif %}
    </div>
    {% endif %}
  </div>

  <div class="editor-header">
    <h1>
      {% if form.instance.pk %}
        Edit Blog Post
      {% else %}
        Create New Blog Post
      {% endif %}
    </h1>
  </div>
  
  <form method="post" enctype="multipart/form-data" id="blog-form">
    {% csrf_token %}
    
    <!-- Basic Information -->
    <div class="form-section">
      <h2>Basic Information</h2>
      
      <div class="form-group">
        {{ form.title.label_tag }}
        {{ form.title }}
        {% if form.title.errors %}
          <div class="error-message">{{ form.title.errors }}</div>
        {% endif %}
      </div>
      
      <div class="form-group">
        {{ form.lead_paragraph.label_tag }}
        {{ form.lead_paragraph }}
        {% if form.lead_paragraph.help_text %}
          <div class="help-text">{{ form.lead_paragraph.help_text }}</div>
        {% endif %}
        {% if form.lead_paragraph.errors %}
          <div class="error-message">{{ form.lead_paragraph.errors }}</div>
        {% endif %}
      </div>
    </div>
    
    <!-- Content -->
    <div class="form-section">
      <h2>Content</h2>
      {{ form.content.label_tag }}
      {{ form.content }}
      {% if form.content.errors %}
        <div class="error-message">{{ form.content.errors }}</div>
      {% endif %}
    </div>
    
    <!-- Media -->
    <div class="form-section">
      <h2>Media</h2>
      
      <div class="form-row">
        <div class="form-group">
          {{ form.image.label_tag }}
          <div class="file-upload-area">
            <svg class="file-upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            <p class="file-upload-text">Click to upload or drag and drop</p>
            <p class="file-upload-text" style="font-size: 0.75rem;">PNG, JPG, GIF up to 10MB</p>
            {{ form.image }}
          </div>
          {% if form.image.errors %}
            <div class="error-message">{{ form.image.errors }}</div>
          {% endif %}
          {% if form.instance.image %}
            <div class="image-preview">
              <p>Current image:</p>
              <img src="{{ form.instance.image.url }}" alt="{{ form.instance.image_alt_text }}">
            </div>
          {% endif %}
        </div>
        
        <div class="form-group">
          {{ form.image_alt_text.label_tag }}
          {{ form.image_alt_text }}
          {% if form.image_alt_text.help_text %}
            <div class="help-text">{{ form.image_alt_text.help_text }}</div>
          {% endif %}
          {% if form.image_alt_text.errors %}
            <div class="error-message">{{ form.image_alt_text.errors }}</div>
          {% endif %}
        </div>
      </div>
    </div>
    
    <!-- Gallery -->
    <div class="form-section">
      <h2>Image Gallery</h2>
      <div class="help-text" style="margin-bottom: 20px;">Add multiple images that will appear as a gallery after the blog content.</div>
      
      <!-- Multi-upload drag and drop area -->
      <div id="gallery-dropzone" class="gallery-dropzone">
        <svg class="dropzone-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
        </svg>
        <p class="dropzone-text">Drag and drop multiple images here</p>
        <p class="dropzone-text" style="font-size: 0.75rem;">Or click to select files</p>
        <input type="file" id="multi-upload-input" accept="image/*" multiple style="display: none;">
      </div>
      
      <div class="gallery-formset" id="gallery-container">
        {{ gallery_formset.management_form }}
        
        {% if gallery_formset.forms %}
          {% for gallery_form in gallery_formset.forms %}
            <div class="gallery-item" id="gallery-item-{{ forloop.counter0 }}">
              <div class="gallery-delete-container">
                {{ gallery_form.DELETE }}
                <label for="{{ gallery_form.DELETE.id_for_label }}" class="gallery-delete-btn" title="Remove this image">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                </label>
                <span class="gallery-delete-text">Remove</span>
              </div>
              
              <div class="gallery-item-header">
                <span class="gallery-item-title">Image {{ forloop.counter }}</span>
              </div>
              
              {{ gallery_form.id }}
              
              <div class="gallery-form-row">
                <div class="form-group">
                  {{ gallery_form.image.label_tag }}
                  {{ gallery_form.image }}
                  {% if gallery_form.image.errors %}
                    <div class="error-message">{{ gallery_form.image.errors }}</div>
                  {% endif %}
                  
                  {% if gallery_form.instance.image %}
                    <img src="{{ gallery_form.instance.image.url }}" alt="{{ gallery_form.instance.alt_text }}" class="gallery-preview">
                  {% endif %}
                </div>
                
                <div class="form-group">
                  {{ gallery_form.caption.label_tag }}
                  {{ gallery_form.caption }}
                  {% if gallery_form.caption.errors %}
                    <div class="error-message">{{ gallery_form.caption.errors }}</div>
                  {% endif %}
                  
                  {{ gallery_form.alt_text.label_tag }}
                  {{ gallery_form.alt_text }}
                  {% if gallery_form.alt_text.errors %}
                    <div class="error-message">{{ gallery_form.alt_text.errors }}</div>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="empty-gallery-message" id="empty-gallery-message">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <p>No gallery images yet</p>
            <p style="font-size: 0.875rem;">Drag and drop images above or click "Add Image" below</p>
          </div>
        {% endif %}
        
        <button type="button" class="gallery-add-btn" id="add-gallery-image">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Add Image
        </button>
      </div>
    </div>
    
    <!-- Organization -->
    <div class="form-section">
      <h2>Organization</h2>
      
      <div class="form-row">
        <div class="form-group">
          {{ form.category.label_tag }}
          {{ form.category }}
          {% if form.category.errors %}
            <div class="error-message">{{ form.category.errors }}</div>
          {% endif %}
        </div>
        
        <div class="form-group">
          {{ form.author.label_tag }}
          {{ form.author }}
          {% if form.author.errors %}
            <div class="error-message">{{ form.author.errors }}</div>
          {% endif %}
        </div>
      </div>
    </div>
    
    <!-- SEO -->
    <div class="form-section">
      <h2>SEO Settings</h2>
      
      <div class="form-group">
        {{ form.slug.label_tag }}
        {{ form.slug }}
        {% if form.slug.help_text %}
          <div class="help-text">{{ form.slug.help_text }}</div>
        {% endif %}
        {% if form.slug.errors %}
          <div class="error-message">{{ form.slug.errors }}</div>
        {% endif %}
      </div>
      
      <div class="form-group">
        {{ form.meta_title.label_tag }}
        {{ form.meta_title }}
        {% if form.meta_title.help_text %}
          <div class="help-text">{{ form.meta_title.help_text }}</div>
        {% endif %}
        <div class="char-counter" id="meta-title-counter"></div>
        {% if form.meta_title.errors %}
          <div class="error-message">{{ form.meta_title.errors }}</div>
        {% endif %}
      </div>
      
      <div class="form-group">
        {{ form.meta_description.label_tag }}
        {{ form.meta_description }}
        {% if form.meta_description.help_text %}
          <div class="help-text">{{ form.meta_description.help_text }}</div>
        {% endif %}
        <div class="char-counter" id="meta-desc-counter"></div>
        {% if form.meta_description.errors %}
          <div class="error-message">{{ form.meta_description.errors }}</div>
        {% endif %}
      </div>
    </div>
    
    <!-- Publishing -->
    <div class="form-section">
      <h2>Publishing</h2>
      
      <div class="form-check">
        {{ form.published }}
        {{ form.published.label_tag }}
        {% if form.published.help_text %}
          <div class="help-text">{{ form.published.help_text }}</div>
        {% endif %}
      </div>
    </div>
    
    <!-- Actions -->
    <div class="form-actions">
      <div class="form-actions-left">
        {% if form.instance.pk %}
        <button type="button" class="btn btn-danger" onclick="if(confirm('Are you sure you want to delete this post?')) { window.location.href='{% url 'delete_blog_post' form.instance.pk %}'; }">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
          </svg>
          Delete
        </button>
        {% endif %}
      </div>
      
      <div class="form-actions-right">
        <a href="{% url 'show_blogs_editing' %}" class="btn btn-secondary">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
          Cancel
        </a>
        <button type="submit" name="save-draft" class="btn btn-primary">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
          </svg>
          Save Draft
        </button>
        <button type="submit" name="save-publish" class="btn btn-success">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          Save & Publish
        </button>
      </div>
    </div>
  </form>
</div>

<!-- Quick Actions -->
<div class="editor-quick-actions">
  <button type="button" class="quick-action-btn" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" title="Back to top">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
    </svg>
  </button>
  {% if form.instance.pk %}
  <a href="/blog/{{form.instance.published_year}}/{{ form.instance.slug }}" target="_blank" class="quick-action-btn" title="Preview">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
    </svg>
  </a>
  {% endif %}
  <button type="button" class="quick-action-btn primary" onclick="document.getElementById('blog-form').submit()" title="Quick save">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
    </svg>
  </button>
</div>

<div class="loading-overlay" id="loading-overlay">
  <div class="loading-spinner"></div>
</div>

<script>
// Auto-save functionality
let autoSaveTimer;
const form = document.getElementById('blog-form');
const loadingOverlay = document.getElementById('loading-overlay');
const saveStatus = document.getElementById('save-status');

function updateSaveStatus(status, text) {
  const statusDot = saveStatus.querySelector('.dot');
  const statusText = saveStatus.querySelector('.status-text');
  
  statusText.textContent = text;
  
  switch(status) {
    case 'saving':
      saveStatus.classList.remove('saved');
      saveStatus.classList.add('saving');
      break;
    case 'saved':
      saveStatus.classList.remove('saving');
      saveStatus.classList.add('saved');
      break;
    default:
      saveStatus.classList.remove('saving', 'saved');
  }
}

function showLoading() {
  loadingOverlay.style.display = 'flex';
}

function hideLoading() {
  loadingOverlay.style.display = 'none';
}

function autoSave() {
  clearTimeout(autoSaveTimer);
  autoSaveTimer = setTimeout(() => {
    updateSaveStatus('saving', 'Saving...');
    const formData = new FormData(form);
    formData.append('auto-save', 'true');
    
    fetch(window.location.href, {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        updateSaveStatus('saved', 'Saved');
        setTimeout(() => updateSaveStatus('', 'Ready'), 3000);
      } else {
        updateSaveStatus('', 'Error saving');
      }
    })
    .catch(error => {
      console.error('Auto-save error:', error);
      updateSaveStatus('', 'Error saving');
    });
  }, 3000); // Auto-save after 3 seconds of inactivity
}

// Add auto-save listeners to form inputs
form.addEventListener('input', autoSave);
form.addEventListener('change', autoSave);

// Status display
function showStatus(message) {
  const status = document.createElement('div');
  status.className = 'editor-status';
  status.textContent = message;
  document.body.appendChild(status);
  
  setTimeout(() => {
    status.remove();
  }, 3000);
}

// Slug generation from title
const titleInput = document.querySelector('input[name="title"]');
const slugInput = document.querySelector('input[name="slug"]');

if (titleInput && slugInput) {
  titleInput.addEventListener('blur', function() {
    if (!slugInput.value) {
      const slug = this.value
        .toLowerCase()
        .replace(/[^\w\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/--+/g, '-')
        .trim();
      slugInput.value = slug;
    }
  });
}

// Character counter for SEO fields
function addCharCounter(input, counterId, maxLength) {
  const counter = document.getElementById(counterId);
  
  function updateCounter() {
    const remaining = maxLength - input.value.length;
    counter.textContent = `${remaining} characters remaining`;
    counter.classList.toggle('warning', remaining < 10);
  }
  
  input.addEventListener('input', updateCounter);
  updateCounter();
}

const metaTitleInput = document.querySelector('input[name="meta_title"]');
const metaDescInput = document.querySelector('textarea[name="meta_description"]');

if (metaTitleInput) addCharCounter(metaTitleInput, 'meta-title-counter', 60);
if (metaDescInput) addCharCounter(metaDescInput, 'meta-desc-counter', 160);

// Form submission with loading state
form.addEventListener('submit', function(e) {
  showLoading();
});

// File upload preview
const fileInput = document.querySelector('input[type="file"]');
const fileUploadArea = document.querySelector('.file-upload-area');

if (fileInput && fileUploadArea) {
  fileInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      const fileName = file.name;
      const fileSize = (file.size / 1024 / 1024).toFixed(2);
      fileUploadArea.querySelector('.file-upload-text').textContent = `${fileName} (${fileSize}MB)`;
    }
  });
}

// Prevent accidental navigation
let formChanged = false;

form.addEventListener('change', () => {
  formChanged = true;
});

window.addEventListener('beforeunload', (e) => {
  if (formChanged) {
    e.preventDefault();
    e.returnValue = '';
  }
});

// Reset formChanged on successful save
form.addEventListener('submit', () => {
  formChanged = false;
});

// Gallery formset management
const addGalleryBtn = document.getElementById('add-gallery-image');
const galleryContainer = document.getElementById('gallery-container');
const totalFormsInput = document.querySelector('#id_gallery_images-TOTAL_FORMS');
const maxFormsInput = document.querySelector('#id_gallery_images-MAX_NUM_FORMS');
const galleryDropzone = document.getElementById('gallery-dropzone');
const multiUploadInput = document.getElementById('multi-upload-input');
const emptyGalleryMessage = document.getElementById('empty-gallery-message');

// Set max files from Django formset configuration
const maxFiles = parseInt(maxFormsInput ? maxFormsInput.value : 10);

// Drag and drop functionality
if (galleryDropzone) {
  const events = ['dragenter', 'dragover', 'dragleave', 'drop'];
  
  // Prevent default behavior for these events
  events.forEach(eventName => {
    galleryDropzone.addEventListener(eventName, preventDefaults, false);
  });
  
  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }
  
  // Highlight drop area when item is dragged over it
  ['dragenter', 'dragover'].forEach(eventName => {
    galleryDropzone.addEventListener(eventName, highlight, false);
  });
  
  ['dragleave', 'drop'].forEach(eventName => {
    galleryDropzone.addEventListener(eventName, unhighlight, false);
  });
  
  function highlight() {
    galleryDropzone.classList.add('dragover');
  }
  
  function unhighlight() {
    galleryDropzone.classList.remove('dragover');
  }
  
  // Handle dropped files
  galleryDropzone.addEventListener('drop', handleDrop, false);
  
  function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    handleFiles(files);
  }
  
  // Handle click to select files
  galleryDropzone.addEventListener('click', () => {
    multiUploadInput.click();
  });
  
  multiUploadInput.addEventListener('change', function() {
    handleFiles(this.files);
  });
  
  // Process multiple files
  function handleFiles(files) {
    const currentCount = parseInt(totalFormsInput.value);
    const remainingSlots = maxFiles - currentCount;
    
    if (files.length > remainingSlots) {
      alert(`You can only add ${remainingSlots} more image${remainingSlots === 1 ? '' : 's'}. Maximum gallery size is ${maxFiles} images.`);
      files = Array.from(files).slice(0, remainingSlots);
    }
    
    if (files.length === 0) return;
    
    // Remove empty gallery message if present
    if (emptyGalleryMessage) {
      emptyGalleryMessage.remove();
    }
    
    // Process each file
    Array.from(files).forEach((file, index) => {
      if (!file.type.match('image.*')) {
        alert(`File '${file.name}' is not an image. Only images are allowed.`);
        return;
      }
      
      // Create new form for this image
      createImageForm(file, currentCount + index);
    });
  }
  
  // Create a new form for an image
  function createImageForm(file, index) {
    // Create new gallery item
    const newForm = document.createElement('div');
    newForm.className = 'gallery-item';
    newForm.id = `gallery-item-${index}`;
    
    // Format file size
    const fileSize = (file.size / 1024 / 1024).toFixed(2);
    
    newForm.innerHTML = `
      <div class="gallery-delete-container">
        <input type="checkbox" name="gallery_images-${index}-DELETE" id="id_gallery_images-${index}-DELETE">
        <label for="id_gallery_images-${index}-DELETE" class="gallery-delete-btn" title="Remove this image">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
          </svg>
        </label>
        <span class="gallery-delete-text">Remove</span>
      </div>
      
      <div class="gallery-item-header">
        <span class="gallery-item-title">Image ${index + 1}</span>
      </div>
      
      <input type="hidden" name="gallery_images-${index}-id" id="id_gallery_images-${index}-id">
      
      <div class="gallery-form-row">
        <div class="form-group">
          <label for="id_gallery_images-${index}-image">Image</label>
          <p class="file-name">${file.name} (${fileSize}MB)</p>
          <input type="file" name="gallery_images-${index}-image" class="form-control gallery-image-input" accept="image/*" id="id_gallery_images-${index}-image" style="display: none;">
          <div class="gallery-preview-container"></div>
        </div>
        
        <div class="form-group">
          <label for="id_gallery_images-${index}-caption">Caption</label>
          <input type="text" name="gallery_images-${index}-caption" class="form-control" placeholder="Caption (optional)" id="id_gallery_images-${index}-caption">
          
          <label for="id_gallery_images-${index}-alt_text">Alt text</label>
          <input type="text" name="gallery_images-${index}-alt_text" class="form-control" placeholder="Alt text for accessibility (optional)" id="id_gallery_images-${index}-alt_text">
        </div>
      </div>
    `;
    
    // Insert before the add button
    galleryContainer.insertBefore(newForm, addGalleryBtn);
    
    // Update total forms
    totalFormsInput.value = parseInt(totalFormsInput.value) + 1;
    
    // Set file to input field
    const fileInput = document.getElementById(`id_gallery_images-${index}-image`);
    
    // Use DataTransfer to create a valid FileList object
    const dataTransfer = new DataTransfer();
    dataTransfer.items.add(file);
    fileInput.files = dataTransfer.files;
    
    // Show image preview
    const reader = new FileReader();
    reader.onload = function(e) {
      const previewContainer = newForm.querySelector('.gallery-preview-container');
      const previewImg = document.createElement('img');
      previewImg.className = 'gallery-preview';
      previewImg.src = e.target.result;
      previewContainer.appendChild(previewImg);
    };
    reader.readAsDataURL(file);
    
    formChanged = true;
  }
}

if (addGalleryBtn && totalFormsInput) {
  addGalleryBtn.addEventListener('click', () => {
    const currentForms = parseInt(totalFormsInput.value);
    const maxForms = parseInt(maxFormsInput.value);
    
    if (currentForms >= maxForms) {
      alert(`Maximum of ${maxForms} images allowed.`);
      return;
    }
    
    // Remove empty gallery message if present
    const emptyMessage = document.querySelector('.empty-gallery-message');
    if (emptyMessage) {
      emptyMessage.remove();
    }
    
    // Get the template form
    const templateForm = document.querySelector('.gallery-item');
    let newForm;
    
    if (templateForm) {
      // Clone existing form
      newForm = templateForm.cloneNode(true);
      
      // Update form index
      const formRegex = new RegExp(`gallery_images-(\\d+)-`, 'g');
      const newFormHtml = newForm.innerHTML.replace(formRegex, `gallery_images-${currentForms}-`);
      newForm.innerHTML = newFormHtml;
      
      // Update form ID and title
      newForm.id = `gallery-item-${currentForms}`;
      const titleElement = newForm.querySelector('.gallery-item-title');
      if (titleElement) {
        titleElement.textContent = `Image ${currentForms + 1}`;
      }
      
      // Clear input values
      const inputs = newForm.querySelectorAll('input:not([type="hidden"]):not([type="checkbox"])');
      inputs.forEach(input => {
        input.value = '';
      });
      
      // Clear preview image if exists
      const previewImg = newForm.querySelector('.gallery-preview');
      if (previewImg) {
        previewImg.remove();
      }
    } else {
      // Create new form from scratch if no template exists
      newForm = document.createElement('div');
      newForm.className = 'gallery-item';
      newForm.id = `gallery-item-${currentForms}`;
      newForm.innerHTML = `
        <div class="gallery-delete-container">
          <input type="checkbox" name="gallery_images-${currentForms}-DELETE" id="id_gallery_images-${currentForms}-DELETE">
          <label for="id_gallery_images-${currentForms}-DELETE" class="gallery-delete-btn" title="Remove this image">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
          </label>
          <span class="gallery-delete-text">Remove</span>
        </div>
        
        <div class="gallery-item-header">
          <span class="gallery-item-title">Image ${currentForms + 1}</span>
        </div>
        
        <input type="hidden" name="gallery_images-${currentForms}-id" id="id_gallery_images-${currentForms}-id">
        
        <div class="gallery-form-row">
          <div class="form-group">
            <label for="id_gallery_images-${currentForms}-image">Image</label>
            <input type="file" name="gallery_images-${currentForms}-image" class="form-control gallery-image-input" accept="image/*" id="id_gallery_images-${currentForms}-image">
          </div>
          
          <div class="form-group">
            <label for="id_gallery_images-${currentForms}-caption">Caption</label>
            <input type="text" name="gallery_images-${currentForms}-caption" class="form-control" placeholder="Caption (optional)" id="id_gallery_images-${currentForms}-caption">
            
            <label for="id_gallery_images-${currentForms}-alt_text">Alt text</label>
            <input type="text" name="gallery_images-${currentForms}-alt_text" class="form-control" placeholder="Alt text for accessibility (optional)" id="id_gallery_images-${currentForms}-alt_text">
          </div>
        </div>
      `;
    }
    
    // Insert before the add button
    galleryContainer.insertBefore(newForm, addGalleryBtn);
    
    // Update total forms
    totalFormsInput.value = currentForms + 1;
    
    // Add image preview listener
    const newImageInput = newForm.querySelector('input[type="file"]');
    if (newImageInput) {
      addImagePreviewListener(newImageInput);
    }
    
    // Add delete button functionality
    const deleteBtn = newForm.querySelector('.gallery-delete-btn');
    if (deleteBtn) {
      addDeleteButtonListener(deleteBtn);
    }
    
    formChanged = true;
  });
  
  // Enhanced delete button functionality
  function addDeleteButtonListener(deleteBtn) {
    deleteBtn.addEventListener('click', function(e) {
      e.preventDefault();
      const galleryItem = this.closest('.gallery-item');
      const checkbox = galleryItem.querySelector('input[type="checkbox"]');
      
      if (checkbox) {
        // Add visual feedback
        if (checkbox.checked) {
          // Unmark for deletion
          checkbox.checked = false;
          galleryItem.classList.remove('marked-for-deletion');
          this.style.background = '';
          this.style.color = '';
          this.setAttribute('title', 'Remove this image');
          
          // Update text if present
          const deleteText = this.parentNode.querySelector('.gallery-delete-text');
          if (deleteText) {
            deleteText.textContent = 'Remove';
          }
        } else {
          // Mark for deletion
          checkbox.checked = true;
          galleryItem.classList.add('marked-for-deletion');
          this.style.background = 'linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)';
          this.style.color = 'white';
          this.style.borderColor = '#dc2626';
          this.setAttribute('title', 'Undo removal');
          
          // Update text if present
          const deleteText = this.parentNode.querySelector('.gallery-delete-text');
          if (deleteText) {
            deleteText.textContent = 'Undo';
          }
        }
      }
    });
  }
  
  // Add delete button listeners to existing gallery items
  document.querySelectorAll('.gallery-delete-btn').forEach(btn => {
    addDeleteButtonListener(btn);
  });
  
  // Image preview function
  function addImagePreviewListener(fileInput) {
    fileInput.addEventListener('change', function() {
      const parentGroup = this.closest('.form-group');
      let previewImg = parentGroup.querySelector('.gallery-preview');
      
      if (this.files && this.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
          if (!previewImg) {
            previewImg = document.createElement('img');
            previewImg.className = 'gallery-preview';
            parentGroup.appendChild(previewImg);
          }
          previewImg.src = e.target.result;
        }
        
        reader.readAsDataURL(this.files[0]);
      } else if (previewImg) {
        previewImg.remove();
      }
    });
  }
  
  
  // REMOVED DEBUG CODE - It was blocking form submission
  // If you need debugging, uncomment the following line:
  // window.enableBlogDebug = true;
  
  if (window.enableBlogDebug) {
    form.addEventListener('submit', function(e) {
      console.log('=== FORM SUBMISSION DEBUG ===');
      console.log('Debug mode is enabled - form will submit normally after logging');
      
      // Log form data without preventing submission
      const formData = new FormData(this);
      console.log('Form fields:');
      for (let [key, value] of formData.entries()) {
        if (value instanceof File) {
          console.log(`  ${key}: FILE - ${value.name} (${value.size} bytes)`);
        } else {
          console.log(`  ${key}: ${value.slice(0, 100)}${value.length > 100 ? '...' : ''}`);
        }
      }
      console.log('=== END DEBUG ===');
      
      // DO NOT prevent form submission!
      // e.preventDefault() was causing the duplicate submissions
    });
  }
  
  
  // Monitor form changes for auto-save
  form.addEventListener('change', () => {
    formChanged = true;
    autoSave();
  });
  
  
  // Error handler
  window.addEventListener('error', function(e) {
    console.error('JavaScript Error:', e.error);
    // Don't show error to user unless it's critical
  });
  
  // REAL-TIME VALIDATION
  function addRealTimeValidation() {
    const titleInput = document.querySelector('input[name="title"]');
    const contentInput = document.querySelector('textarea[name="content"]') || document.querySelector('#id_content');
    
    if (titleInput) {
      const titleGroup = titleInput.closest('.form-group');
      const titleIndicator = document.createElement('span');
      titleIndicator.className = 'validation-indicator';
      titleGroup.style.position = 'relative';
      titleGroup.appendChild(titleIndicator);
      
      titleInput.addEventListener('input', function() {
        const length = this.value.trim().length;
        if (length >= 3 && length <= 120) {
          titleIndicator.textContent = '✅';
          titleIndicator.className = 'validation-indicator valid';
        } else {
          titleIndicator.textContent = '❌';
          titleIndicator.className = 'validation-indicator invalid';
        }
      });
    }
    
    if (contentInput) {
      const contentGroup = contentInput.closest('.form-group');
      const contentIndicator = document.createElement('span');
      contentIndicator.className = 'validation-indicator';
      const charCounter = document.createElement('div');
      charCounter.className = 'char-counter live';
      
      contentGroup.style.position = 'relative';
      contentGroup.appendChild(contentIndicator);
      contentGroup.appendChild(charCounter);
      
      const updateContentValidation = function() {
        const content = this.value || '';
        const textContent = content.replace(/<[^>]*>/g, '').trim(); // Strip HTML
        const length = textContent.length;
        
        charCounter.textContent = `${length} characters`;
        
        if (length >= 10) {
          contentIndicator.textContent = '✅';
          contentIndicator.className = 'validation-indicator valid';
          charCounter.className = 'char-counter live';
        } else {
          contentIndicator.textContent = '❌';
          contentIndicator.className = 'validation-indicator invalid';
          charCounter.className = 'char-counter live warning';
          charCounter.textContent = `${length}/10 characters (too short!)`;
        }
      };
      
      contentInput.addEventListener('input', updateContentValidation);
      contentInput.addEventListener('keyup', updateContentValidation);
      
      // For TinyMCE, also listen to its events
      if (window.tinymce) {
        window.tinymce.on('AddEditor', function(e) {
          e.editor.on('keyup change', updateContentValidation);
        });
      }
    }
  }
  
  // Add real-time validation when page loads
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(addRealTimeValidation, 1000); // Wait for TinyMCE to load
  });
  
  // Also try to add it immediately
  addRealTimeValidation();

  // FRONTEND ERROR HANDLING FUNCTIONS
  function showErrorAlert(title, message, errors = null) {
    const errorAlert = document.getElementById('error-alert');
    const errorContent = document.getElementById('error-alert-content');
    
    let content = `<p>${message}</p>`;
    
    if (errors && typeof errors === 'object') {
      content += '<ul class="error-list">';
      
      if (Array.isArray(errors)) {
        errors.forEach(error => {
          content += `<li>${error}</li>`;
        });
      } else {
        Object.keys(errors).forEach(field => {
          const fieldErrors = Array.isArray(errors[field]) ? errors[field] : [errors[field]];
          fieldErrors.forEach(error => {
            content += `<li><strong>${field}:</strong> ${error}</li>`;
          });
        });
      }
      
      content += '</ul>';
    }
    
    errorContent.innerHTML = content;
    errorAlert.classList.add('show');
    
    // Auto-hide after 10 seconds
    setTimeout(() => {
      hideErrorAlert();
    }, 10000);
  }
  
  function hideErrorAlert() {
    const errorAlert = document.getElementById('error-alert');
    errorAlert.classList.remove('show');
  }
  
  function showSuccessAlert(message) {
    const successAlert = document.getElementById('success-alert');
    const successContent = document.getElementById('success-alert-content');
    
    successContent.innerHTML = `<p>${message}</p>`;
    successAlert.classList.add('show');
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
      successAlert.classList.remove('show');
    }, 5000);
  }
  
  function showLoadingOverlay(text = 'Saving your blog post...') {
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = loadingOverlay.querySelector('.loading-text');
    loadingText.textContent = text;
    loadingOverlay.classList.add('show');
  }
  
  function hideLoadingOverlay() {
    const loadingOverlay = document.getElementById('loading-overlay');
    loadingOverlay.classList.remove('show');
  }
  
  // ENHANCED FORM SUBMISSION WITH ERROR HANDLING
  // This handler only validates but doesn't prevent submission unless there are errors
  form.addEventListener('submit', function(e) {
    // Hide any existing alerts
    hideErrorAlert();
    
    // Show loading overlay
    showLoadingOverlay();
    
    // Validate form client-side first
    const validationErrors = [];
    
    // Check required fields
    const titleInput = this.querySelector('input[name="title"]');
    const contentInput = this.querySelector('textarea[name="content"], input[name="content"]');
    
    if (!titleInput || !titleInput.value.trim()) {
      validationErrors.push('Title is required');
    } else if (titleInput.value.trim().length < 3) {
      validationErrors.push('Title must be at least 3 characters long');
    }
    
    if (!contentInput || !contentInput.value.trim()) {
      validationErrors.push('Content is required');
    } else if (contentInput.value.trim().length < 10) {
      validationErrors.push('Content must be at least 10 characters long');
    }
    
    // Check image file if present
    const imageInput = this.querySelector('input[name="image"]');
    if (imageInput && imageInput.files && imageInput.files[0]) {
      const file = imageInput.files[0];
      
      // Check file size (10MB limit)
      if (file.size > 10 * 1024 * 1024) {
        validationErrors.push(`Image file is too large (${(file.size/1024/1024).toFixed(2)}MB). Maximum size is 10MB.`);
      }
      
      // Check file type
      const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
      if (!allowedTypes.includes(file.type)) {
        validationErrors.push(`Invalid image format (${file.type}). Please use JPG, PNG, GIF, or WebP.`);
      }
    }
    
    // If validation errors, show them and prevent submission
    if (validationErrors.length > 0) {
      hideLoadingOverlay();
      showErrorAlert('Validation Error', 'Please correct the following errors:', validationErrors);
      e.preventDefault();
      return false;
    }
    
    // Form is valid - let it submit normally
    console.log('Form validation passed - submitting...');
    
    // The form will submit normally and the page will redirect
    // Loading overlay will be shown until redirect happens
  });
  
  // Handle form errors from server (if form is re-rendered with errors)
  document.addEventListener('DOMContentLoaded', function() {
    // Check for Django form errors in the rendered HTML
    const formErrors = document.querySelectorAll('.error-message');
    if (formErrors.length > 0) {
      const errors = [];
      formErrors.forEach(errorEl => {
        errors.push(errorEl.textContent.trim());
      });
      
      if (errors.length > 0) {
        showErrorAlert('Form Error', 'Please correct the following errors:', errors);
      }
    }
    
    // Check for Django messages
    const djangoMessages = document.querySelectorAll('.messages .alert, .messages .message');
    djangoMessages.forEach(messageEl => {
      const text = messageEl.textContent.trim();
      if (messageEl.classList.contains('alert-success') || messageEl.classList.contains('success')) {
        showSuccessAlert(text);
      } else if (messageEl.classList.contains('alert-error') || messageEl.classList.contains('error')) {
        showErrorAlert('Error', text);
      }
    });
  });
  
  // Hide loading overlay if page loads (in case of redirect back to form)
  window.addEventListener('load', function() {
    hideLoadingOverlay();
  });


  
  // Add preview listeners to existing file inputs
  const fileInputs = document.querySelectorAll('.gallery-image-input');
  fileInputs.forEach(input => {
    addImagePreviewListener(input);
  });
}
</script>
{% endblock %}

{% block footer %}
{% endblock %}